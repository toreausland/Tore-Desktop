<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Likviditetskalkulator â€” Aurelian Manufacturing AS</title>
<style>
  :root {
    --accent: #F50537;
    --accent-light: #fde8ec;
    --dark: #2B2B2B;
    --gray: #6B6B6B;
    --light-gray: #F5F5F5;
    --white: #FFFFFF;
    --green: #1B8C4E;
    --green-light: #e6f5ec;
    --red: #D42020;
    --red-light: #fde8e8;
    --yellow: #E8A317;
    --yellow-light: #fef7e6;
    --border: #E0E0E0;
    --shadow: 0 1px 3px rgba(0,0,0,0.08);
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: Calibri, 'Segoe UI', sans-serif;
    background: #f0f0f0; color: var(--dark); line-height: 1.5; min-height: 100vh;
  }
  .header {
    background: var(--dark); color: var(--white);
    padding: 20px 32px; display: flex; align-items: center; justify-content: space-between;
  }
  .header-left { display: flex; align-items: center; gap: 16px; }
  .logo-mark {
    width: 36px; height: 36px; background: var(--accent); border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 18px; color: white; letter-spacing: -1px;
  }
  .header h1 { font-size: 20px; font-weight: 600; letter-spacing: 0.3px; }
  .header-sub { font-size: 13px; color: #999; font-weight: 400; }
  .container { max-width: 1600px; margin: 0 auto; padding: 24px; }
  .card {
    background: var(--white); border-radius: 8px;
    box-shadow: var(--shadow); margin-bottom: 20px; overflow: hidden;
  }
  .card-header {
    padding: 14px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .card-header h2 {
    font-size: 15px; font-weight: 600; color: var(--dark);
    display: flex; align-items: center; gap: 8px;
  }
  .card-header h2 .dot {
    width: 8px; height: 8px; border-radius: 50%; background: var(--accent); display: inline-block;
  }
  .card-body { padding: 20px; }
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  label {
    display: block; font-size: 12px; font-weight: 600; color: var(--gray);
    margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;
  }
  input[type="number"], input[type="text"], input[type="month"], input[type="date"], select {
    width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 4px;
    font-family: Calibri, sans-serif; font-size: 14px; color: var(--dark);
    background: var(--white); transition: border-color 0.2s;
  }
  input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-light); }
  .field { margin-bottom: 14px; }
  .slider-group { margin-bottom: 16px; }
  .slider-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .slider-label span:first-child { font-size: 12px; font-weight: 600; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; }
  .slider-value { font-size: 14px; font-weight: 700; color: var(--dark); background: var(--light-gray); padding: 2px 10px; border-radius: 3px; }
  input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px; background: var(--border); outline: none; }
  input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 1px 4px rgba(245,5,55,0.3); }
  input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: var(--accent); cursor: pointer; border: none; }
  .toggle-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; }
  .toggle-row span { font-size: 13px; color: var(--dark); }
  .toggle { position: relative; width: 40px; height: 22px; cursor: pointer; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle .slider-track { position: absolute; inset: 0; background: var(--border); border-radius: 11px; transition: 0.3s; }
  .toggle .slider-track::before { content: ''; position: absolute; width: 16px; height: 16px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
  .toggle input:checked + .slider-track { background: var(--accent); }
  .toggle input:checked + .slider-track::before { transform: translateX(18px); }
  .summary-row { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 20px; }
  .summary-card { background: var(--light-gray); border-radius: 8px; padding: 12px 16px; text-align: center; }
  .summary-box { padding: 16px; border-radius: 6px; border-left: 4px solid; }
  .summary-box.blue { background: #e8f0fe; border-color: #3366cc; }
  .summary-box.green { background: var(--green-light); border-color: var(--green); }
  .summary-box.red { background: var(--red-light); border-color: var(--red); }
  .summary-box.neutral { background: var(--light-gray); border-color: var(--gray); }
  .summary-box .s-label { font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--gray); margin-bottom: 4px; }
  .summary-box .s-value { font-size: 22px; font-weight: 700; color: var(--dark); }
  .summary-box .s-sub { font-size: 11px; color: var(--gray); margin-top: 2px; }
  .cost-table { width: 100%; border-collapse: collapse; }
  .cost-table th { text-align: left; font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; letter-spacing: 0.5px; padding: 6px 8px; border-bottom: 2px solid var(--dark); }
  .cost-table th.r { text-align: right; }
  .cost-table td.r { text-align: right; }
  .cost-table td { padding: 4px 8px; border-bottom: 1px solid var(--border); font-size: 13px; vertical-align: middle; }
  .cost-table input[type="text"], .cost-table input[type="number"] { border: none; background: transparent; font-size: 13px; padding: 4px 0; width: 100%; font-family: Calibri, sans-serif; }
  .cost-table input:focus { outline: none; background: var(--accent-light); border-radius: 2px; box-shadow: none; }
  .cost-table .num-input { text-align: right; }
  .cost-table select, .cost-table input[type="month"], .cost-table input[type="date"] { border: none; background: transparent; font-size: 12px; padding: 4px 0; font-family: Calibri, sans-serif; cursor: pointer; width: 100%; }
  .cost-table select:focus, .cost-table input[type="month"]:focus, .cost-table input[type="date"]:focus { outline: none; background: var(--accent-light); box-shadow: none; }
  .cost-table tfoot td { font-weight: 700; border-top: 2px solid var(--dark); border-bottom: none; padding: 8px; }
  .btn-add { display: inline-flex; align-items: center; gap: 4px; background: none; border: 1px dashed var(--border); color: var(--gray); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: Calibri, sans-serif; margin-top: 8px; transition: all 0.2s; }
  .btn-add:hover { border-color: var(--accent); color: var(--accent); }
  .btn-remove { background: none; border: none; color: #ccc; cursor: pointer; font-size: 16px; padding: 0 4px; transition: color 0.2s; }
  .btn-remove:hover { color: var(--red); }
  .month-table-wrap { overflow-x: auto; margin: 0 -20px; padding: 0 20px; }
  .month-table { width: 100%; min-width: 1200px; border-collapse: collapse; font-size: 12px; }
  .month-table th { padding: 10px 8px; text-align: right; font-weight: 600; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
  .month-table thead tr:first-child th { background: var(--dark); color: var(--white); border: none; }
  .month-table thead tr:first-child th:first-child { text-align: left; border-radius: 4px 0 0 0; }
  .month-table thead tr:first-child th:last-child { border-radius: 0 4px 0 0; }
  .month-table tbody td { padding: 7px 8px; text-align: right; border-bottom: 1px solid var(--border); white-space: nowrap; }
  .month-table tbody td:first-child { text-align: left; font-weight: 600; color: var(--dark); }
  .month-table tbody tr:nth-child(even) { background: var(--light-gray); }
  .month-table tbody tr.row-section td { font-weight: 700; background: #f8f8f8 !important; border-top: 2px solid var(--border); }
  .month-table tbody tr.row-balance td { font-weight: 700; font-size: 13px; border-top: 2px solid var(--dark); background: var(--white) !important; }
  .month-table tbody tr.row-mva-refund td { background: var(--green-light) !important; color: var(--green); font-weight: 600; }
  .month-table tbody tr.row-mva-pay td { background: var(--yellow-light) !important; color: var(--yellow); font-weight: 600; }
  .month-table tbody tr.row-ferie-accrual td { background: #f0e8fe !important; color: #7B2D8E; font-weight: 600; font-size: 11px; }
  .month-table tbody tr.row-aga-accrual td { background: #e8f0fe !important; color: #3366cc; font-weight: 600; font-size: 11px; }
  .month-table tbody tr.row-stress td { color: var(--red); font-style: italic; }
  .month-table tbody tr.row-stress-balance td { font-weight: 700; font-size: 13px; border-top: 2px solid var(--red); color: var(--red); }
  .month-table tbody tr.row-stress-diff td { font-size: 11px; color: var(--gray); font-style: italic; }
  .breach-cell { background: var(--red-light) !important; color: var(--red) !important; font-weight: 700 !important; }
  .balance-bar-row { display: flex; gap: 2px; margin-top: 4px; height: 32px; }
  .balance-bar { flex: 1; border-radius: 3px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: white; transition: all 0.3s; }
  .balance-bar.positive { background: var(--green); }
  .balance-bar.warning { background: var(--yellow); }
  .balance-bar.negative { background: var(--red); }
  .balance-bar .bar-label { font-size: 9px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 0 2px; }
  .bar-labels-row { display: flex; gap: 2px; margin-top: 2px; }
  .bar-labels-row > div { flex: 1; text-align: center; font-size: 10px; color: var(--gray); }
  .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px; }
  .status-dot.green { background: var(--green); } .status-dot.yellow { background: var(--yellow); } .status-dot.red { background: var(--red); }
  .info-tip { display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: var(--border); color: var(--gray); font-size: 10px; font-weight: 700; cursor: help; position: relative; }
  .info-tip:hover::after { content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 6px 10px; border-radius: 4px; font-size: 11px; font-weight: 400; white-space: nowrap; z-index: 100; margin-bottom: 4px; }
  .negative-val { color: var(--red) !important; font-weight: 700; }
  .section-divider { height: 1px; background: var(--border); margin: 8px 0; }
  .otp-detail { font-size: 11px; color: var(--gray); margin-top: 4px; padding: 6px 8px; background: var(--light-gray); border-radius: 3px; }
  .footer { text-align: center; padding: 20px; font-size: 11px; color: var(--gray); }
  .footer span { color: var(--accent); font-weight: 600; }
  .entry-table tbody tr { transition: background 0.15s; }
  .entry-table tbody tr:hover { background: var(--accent-light); }
  .loan-card { border: 1px solid var(--border); border-radius: 6px; padding: 16px; margin-bottom: 12px; transition: box-shadow 0.2s; }
  .loan-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .loan-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .loan-card-header input[type="text"] { font-size: 14px; font-weight: 600; border: none; border-bottom: 1px dashed var(--border); border-radius: 0; padding: 4px 0; background: transparent; width: 260px; }
  .loan-card-header input[type="text"]:focus { border-bottom-color: var(--accent); box-shadow: none; }
  .loan-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 12px; }
  .loan-grid .field { margin-bottom: 0; }
  .loan-grid label { font-size: 10px; margin-bottom: 2px; }
  .loan-grid input, .loan-grid select, .loan-grid input[type="month"] { padding: 6px 8px; font-size: 13px; }
  .loan-summary-row { display: flex; gap: 16px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); font-size: 12px; color: var(--gray); }
  .loan-summary-row .ls-item { display: flex; flex-direction: column; }
  .loan-summary-row .ls-val { font-size: 14px; font-weight: 700; color: var(--dark); }
  .loan-badge { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
  .loan-badge.grace { background: var(--yellow-light); color: var(--yellow); }
  .btn-pdf { background: var(--accent); color: white; border: none; border-radius: 4px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: Calibri, sans-serif; letter-spacing: 0.3px; }
  .btn-pdf:hover { background: #d9042f; }
  .year-nav { display: flex; align-items: center; gap: 8px; }
  .year-nav button { background: none; border: 1px solid var(--border); border-radius: 4px; width: 28px; height: 28px; font-size: 16px; cursor: pointer; color: var(--dark); display: flex; align-items: center; justify-content: center; font-family: inherit; }
  .year-nav button:hover { border-color: var(--accent); color: var(--accent); }
  .year-nav select { width: auto; padding: 4px 8px; font-size: 15px; font-weight: 700; }
  .ib-info { font-size: 11px; color: var(--green); margin-top: 4px; padding: 4px 8px; background: var(--green-light); border-radius: 3px; }
  .print-only { display: none; }
  @media (max-width: 1024px) { .grid-2 { grid-template-columns: 1fr; } .summary-row { grid-template-columns: 1fr 1fr; } #stressPanel > div { grid-template-columns: 1fr 1fr !important; } #vdrGrid1, #vdrGrid2 { grid-template-columns: 1fr !important; } #vdrKPI { grid-template-columns: repeat(3, 1fr) !important; } }
  @media print {
    @page { size: A3 landscape; margin: 15mm 12mm; }
    body { background: white; font-size: 9pt; }
    .header { background: #2B2B2B !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; padding: 12px 20px; }
    .header h1 { font-size: 16pt; }
    .btn-pdf, .btn-add, .btn-remove, .info-tip, .year-nav button { display: none !important; }
    .card { break-inside: avoid; box-shadow: none; border: 1px solid #ddd; margin-bottom: 12px; }
    .no-print { display: none !important; }
    .print-only { display: block !important; }
    .summary-row { gap: 8px; margin-bottom: 12px; } .summary-box { padding: 10px; } .s-value { font-size: 14pt; }
    .month-table { font-size: 8pt; } .month-table th, .month-table td { padding: 4px 6px; }
    .month-table th { background: #2B2B2B !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .row-section td { background: #f0f0f0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .row-balance td { background: #e8e8e8 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .row-mva-refund td { background: #e6f5ec !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .row-mva-pay td { background: #fef7e6 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .row-ferie-accrual td { background: #f0e8fe !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .row-aga-accrual td { background: #e8f0fe !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .row-stress td, .row-stress-balance td { color: #D42020 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .breach-cell { background: #fde8e8 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .balance-bar-row { page-break-inside: avoid; } .bar-fill { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .print-footer { display: block !important; text-align: center; font-size: 8pt; color: #999; border-top: 1px solid #ddd; padding-top: 8px; margin-top: 16px; }
  }
</style>
</head>
<body>
<div class="header">
  <div class="header-left">
    <div class="logo-mark">A</div>
    <div><h1>Likviditetskalkulator</h1><div class="header-sub">Aurelian Manufacturing AS</div></div>
  </div>
  <div class="header-right" style="display:flex;align-items:center;gap:10px;">
    <button onclick="saveData()" class="btn-pdf" style="background:#3366cc;font-size:12px;padding:6px 12px;" title="Lagre alle data til fil">ðŸ’¾ Lagre</button>
    <button onclick="document.getElementById('loadFile').click()" class="btn-pdf" style="background:#6B6B6B;font-size:12px;padding:6px 12px;" title="Last inn data fra fil">ðŸ“‚ Last inn</button>
    <input type="file" id="loadFile" accept=".json" style="display:none" onchange="loadData(event)">
    <button onclick="window.print()" class="btn-pdf">Generer PDF</button>
    <div style="text-align:right"><div>KONFIDENSIELT</div><div id="todayDate"></div></div>
  </div>
</div>
<div class="container">
  <div class="summary-row">
    <div class="summary-box blue"><div class="s-label">InngÃ¥ende balanse</div><div class="s-value" id="sumIB">0</div><div class="s-sub" id="sumIBsub"></div></div>
    <div class="summary-box green"><div class="s-label">Totale inntekter</div><div class="s-value" id="sumInflows">0</div></div>
    <div class="summary-box" style="border-left:4px solid #7B2D8E;"><div class="s-label">Kapitalinnhenting</div><div class="s-value" id="sumCapital">0</div></div>
    <div class="summary-box red"><div class="s-label">Totale utbetalinger</div><div class="s-value" id="sumOutflows">0</div></div>
    <div class="summary-box neutral" id="ubBox"><div class="s-label">UtgÃ¥ende balanse (des)</div><div class="s-value" id="sumUB">0</div><div class="s-sub" id="sumStatus"></div></div>
    <div class="summary-box" id="runwayBox" style="border-left:4px solid #3366cc;"><div class="s-label">Cash runway</div><div class="s-value" id="sumRunway">â€”</div><div class="s-sub" id="runwaySub"></div></div>
  </div>
  <div class="grid-2 no-print">
    <div class="card">
      <div class="card-header"><h2><span class="dot"></span>Grunnoppsett</h2></div>
      <div class="card-body">
        <div class="field">
          <label>VisningsÃ¥r</label>
          <div class="year-nav">
            <button onclick="changeYear(-1)">&larr;</button>
            <select id="viewYear" onchange="onYearChange()">
              <option value="2025">2025</option><option value="2026" selected>2026</option>
              <option value="2027">2027</option><option value="2028">2028</option>
              <option value="2029">2029</option><option value="2030">2030</option>
              <option value="2031">2031</option><option value="2032">2032</option>
              <option value="2033">2033</option><option value="2034">2034</option>
              <option value="2035">2035</option>
            </select>
            <button onclick="changeYear(1)">&rarr;</button>
          </div>
        </div>
        <div class="field">
          <label>InngÃ¥ende balanse (IB) â€” NOK</label>
          <input type="number" id="ibInput" value="0" step="1000" oninput="onIBChange()">
          <div id="ibInfo" class="ib-info" style="display:none"></div>
        </div>
        <div class="section-divider"></div>
        <div class="field">
          <label>GrunnbelÃ¸p (G) â€” NOK</label>
          <input type="number" id="gInput" value="124028" step="1" oninput="renderEmployees(); recalculate()">
        </div>
        <div class="section-divider"></div>
        <div class="field">
          <label>Kundebetalingsfrist (dager)</label>
          <input type="number" id="debtorDays" value="0" min="0" max="120" step="1" oninput="recalculate()">
        </div>
        <div class="field">
          <label>LeverandÃ¸rbetalingsfrist (dager)</label>
          <input type="number" id="creditorDays" value="0" min="0" max="120" step="1" oninput="recalculate()">
        </div>
        <div class="otp-detail" id="betTermInfo" style="display:none"></div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h2><span class="dot"></span>OTP og avgifter</h2></div>
      <div class="card-body">
        <div class="slider-group">
          <div class="slider-label"><span>OTP sats</span><span class="slider-value" id="otpVal">2%</span></div>
          <input type="range" id="otpSlider" min="2" max="7" value="2" oninput="updateSliders(); renderEmployees(); recalculate()">
        </div>
        <div class="toggle-row"><span>18% tillegg over 7,1G</span><label class="toggle"><input type="checkbox" id="otpOver7G" onchange="renderEmployees(); recalculate()"><span class="slider-track"></span></label></div>
        <div class="toggle-row"><span>Arbeidsgiveravgift (14,1%)</span><label class="toggle"><input type="checkbox" id="agaToggle" checked onchange="renderEmployees(); recalculate()"><span class="slider-track"></span></label></div>
        <div class="otp-detail" id="agaDetail">Terminbetaling: jan-feb â†’ 15. mar, mar-apr â†’ 15. mai, mai-jun â†’ 15. jul, jul-aug â†’ 15. sep, sep-okt â†’ 15. nov, nov-des â†’ 15. jan neste Ã¥r.</div>
        <div class="toggle-row"><span>Feriepenger</span><label class="toggle"><input type="checkbox" id="ferieToggle" checked onchange="recalculate()"><span class="slider-track"></span></label></div>
        <div id="ferieDetail" class="otp-detail">12% av foregÃ¥ende Ã¥rs brutto (14,3% for 60+). Erstatter lÃ¸nn i ferieperioden. Ã…r 1: ingen utbetaling.</div>
        <div class="section-divider"></div>
        <div class="toggle-row"><span>Forskuddsskatt (selskap)</span><label class="toggle"><input type="checkbox" id="forskuddsskattToggle" onchange="toggleForskuddsskatt();recalculate()"><span class="slider-track"></span></label></div>
        <div id="forskuddsskattFields" style="display:none;margin-top:6px">
          <div class="field" style="margin-bottom:8px">
            <label>Forventet skattbart overskudd (NOK/Ã¥r)</label>
            <input type="number" id="forskuddsskattBasis" value="0" step="100000" oninput="recalculate()">
          </div>
          <div class="otp-detail">22% selskapsskatt. Betales kvartalsvis: 15. feb, 15. apr, 15. sep, 15. nov.</div>
        </div>
        <div class="section-divider"></div>
        <div class="toggle-row"><span>MVA-registrert (25%)</span><label class="toggle"><input type="checkbox" id="mvaToggle" checked onchange="recalculate()"><span class="slider-track"></span></label></div>
        <div class="otp-detail" id="mvaDetail"></div>
        <div class="otp-detail" id="mvaTermInfo" style="margin-top:4px;font-size:11px;line-height:1.6;color:var(--gray)">
          <strong style="font-size:12px;color:var(--dark)">MVA-terminoppgjÃ¸r â€” nÃ¥r treffer det kontoen?</strong><br>
          Innbetaling (kostnad) skjer med en gang. Refusjon/betaling skjer ved terminforfall:<br>
          <span style="display:inline-grid;grid-template-columns:auto auto auto;gap:1px 12px;margin-top:4px">
            <span>Term 1:</span><span>Jan + Feb</span><span>â†’ oppgjÃ¸r <strong>10. apr</strong></span>
            <span>Term 2:</span><span>Mar + Apr</span><span>â†’ oppgjÃ¸r <strong>10. jun</strong></span>
            <span>Term 3:</span><span>Mai + Jun</span><span>â†’ oppgjÃ¸r <strong>31. aug</strong></span>
            <span>Term 4:</span><span>Jul + Aug</span><span>â†’ oppgjÃ¸r <strong>10. okt</strong></span>
            <span>Term 5:</span><span>Sep + Okt</span><span>â†’ oppgjÃ¸r <strong>10. des</strong></span>
            <span>Term 6:</span><span>Nov + Des</span><span>â†’ oppgjÃ¸r <strong>10. feb neste Ã¥r</strong></span>
          </span>
        </div>
        <div class="otp-detail" id="personnelDetail"></div>
      </div>
    </div>
  </div>
  <div class="grid-2 no-print">
    <div class="card">
      <div class="card-header"><h2><span class="dot"></span>Ansatte</h2><span class="info-tip" data-tip="Ansatte med startdato. Kostnaden beregnes kun for mÃ¥neder etter startdato.">?</span></div>
      <div class="card-body">
        <table class="cost-table entry-table"><thead><tr>
          <th style="width:22%">Navn</th><th class="r" style="width:15%">Brutto Ã¥rslÃ¸nn</th><th style="width:8%">FÃ¸dt</th><th style="width:14%">Startdato</th>
          <th class="r" style="width:12%">OTP / Ã¥r</th><th class="r" style="width:16%">LÃ¸nn+OTP / mnd</th><th style="width:5%"></th>
        </tr></thead><tbody id="employeesBody"></tbody>
        <tfoot><tr><td id="empCountLabel">0 ansatte</td><td style="text-align:right" id="empSalaryTotal"></td><td></td><td></td><td style="text-align:right" id="empOTPTotal"></td><td style="text-align:right;font-weight:700" id="empMonthlyTotal"></td><td></td></tr></tfoot></table>
        <button class="btn-add" onclick="addEmployee()">+ Legg til ansatt</button>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h2><span class="dot"></span>Personalkostnad per mÃ¥ned</h2></div>
      <div class="card-body" id="personnelSummary"></div>
    </div>
  </div>
  <div class="grid-2 no-print">
    <div class="card">
      <div class="card-header"><h2><span class="dot" style="background:var(--green)"></span>Faste inntekter (mÃ¥nedlig)</h2><span class="info-tip" data-tip="LÃ¸pende inntekter med start- og sluttdato.">?</span></div>
      <div class="card-body">
        <table class="cost-table entry-table"><thead><tr>
          <th style="width:24%">Beskrivelse</th><th style="width:14%">Fra</th><th style="width:14%">Til</th><th style="width:6%;text-align:center">MVA</th><th class="r" style="width:22%">NOK / mnd</th><th style="width:5%"></th>
        </tr></thead><tbody id="fixedIncomeBody"></tbody>
        <tfoot><tr><td>Sum faste inntekter</td><td></td><td></td><td></td><td style="text-align:right" id="fixedIncomeTotal">0</td><td></td></tr></tfoot></table>
        <button class="btn-add" onclick="addFixedIncome()">+ Legg til fast inntekt</button>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h2><span class="dot" style="background:var(--green)"></span>Variable inntekter</h2><span class="info-tip" data-tip="Enkeltinntekter plassert pÃ¥ en bestemt dato">?</span></div>
      <div class="card-body">
        <table class="cost-table entry-table"><thead><tr>
          <th style="width:32%">Beskrivelse</th><th style="width:20%">Dato</th><th style="width:6%;text-align:center">MVA</th><th class="r" style="width:26%">BelÃ¸p (NOK)</th><th style="width:8%"></th>
        </tr></thead><tbody id="varIncomeBody"></tbody>
        <tfoot><tr><td>Sum variable inntekter</td><td></td><td></td><td style="text-align:right" id="varIncomeTotal">0</td><td></td></tr></tfoot></table>
        <button class="btn-add" onclick="addEntry('varIncome')">+ Legg til inntekt</button>
      </div>
    </div>
  </div>
  <div class="grid-2 no-print">
    <div class="card">
      <div class="card-header"><h2><span class="dot" style="background:var(--yellow)"></span>Variable / engangskostnader</h2><span class="info-tip" data-tip="Engangskostnader plassert pÃ¥ en bestemt dato">?</span></div>
      <div class="card-body">
        <table class="cost-table entry-table"><thead><tr>
          <th style="width:32%">Beskrivelse</th><th style="width:20%">Dato</th><th style="width:6%;text-align:center">MVA</th><th class="r" style="width:26%">BelÃ¸p (NOK)</th><th style="width:8%"></th>
        </tr></thead><tbody id="varBody"></tbody>
        <tfoot><tr><td>Sum variable kostnader</td><td></td><td></td><td style="text-align:right" id="varTotal">0</td><td></td></tr></tfoot></table>
        <button class="btn-add" onclick="addEntry('var')">+ Legg til kostnad</button>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><h2><span class="dot"></span>Faste mÃ¥nedlige kostnader</h2><span class="info-tip" data-tip="LÃ¸pende kostnader med start- og sluttdato.">?</span></div>
      <div class="card-body">
        <table class="cost-table entry-table"><thead><tr>
          <th style="width:24%">Beskrivelse</th><th style="width:14%">Fra</th><th style="width:14%">Til</th><th style="width:6%;text-align:center">MVA</th><th class="r" style="width:22%">NOK / mnd</th><th style="width:5%"></th>
        </tr></thead><tbody id="fixedBody"></tbody>
        <tfoot><tr><td>Sum faste kostnader</td><td></td><td></td><td></td><td style="text-align:right" id="fixedTotal">0</td><td></td></tr></tfoot></table>
        <button class="btn-add" onclick="addFixed()">+ Legg til kostnad</button>
      </div>
    </div>
  </div>
  <div class="card no-print">
    <div class="card-header"><h2><span class="dot" style="background:#3366cc"></span>LÃ¥n</h2><span class="info-tip" data-tip="AnnuitetslÃ¥n med avdragsfrihet. FÃ¸lger over Ã¥rsskifter automatisk.">?</span></div>
    <div class="card-body"><div id="loansContainer"></div><button class="btn-add" onclick="addLoan()">+ Legg til lÃ¥n</button><div id="loanTotalSummary" style="margin-top:16px"></div></div>
  </div>
  <div class="card no-print">
    <div class="card-header"><h2><span class="dot" style="background:#E8871E"></span>Leasing</h2><span class="info-tip" data-tip="Annuitetsbasert leasing. FÃ¸lger over Ã¥rsskifter automatisk.">?</span></div>
    <div class="card-body"><div id="leasesContainer"></div><button class="btn-add" onclick="addLease()">+ Legg til leasing</button><div id="leaseTotalSummary" style="margin-top:16px"></div></div>
  </div>
  <div class="card no-print">
    <div class="card-header"><h2><span class="dot" style="background:#7B2D8E"></span>Kapitalinnhenting / emisjoner</h2><span class="info-tip" data-tip="Egenkapitalinnhenting, tilskudd etc.">?</span></div>
    <div class="card-body">
      <table class="cost-table entry-table"><thead><tr>
        <th style="width:38%">Beskrivelse</th><th style="width:22%">Dato</th><th class="r" style="width:30%">BelÃ¸p (NOK)</th><th style="width:10%"></th>
      </tr></thead><tbody id="capitalBody"></tbody>
      <tfoot><tr><td>Sum kapitalinnhenting</td><td></td><td style="text-align:right" id="capitalTotal">0</td><td></td></tr></tfoot></table>
      <button class="btn-add" onclick="addEntry('capital')">+ Legg til emisjon / tilskudd</button>
    </div>
  </div>

  <!-- â•â•â• VDR FINANCIAL MODULE â•â•â• -->
  <div class="card">
    <div class="card-header">
      <h2><span class="dot" style="background:#1a1a2e"></span>VDR Finansiell Modell</h2>
      <label class="toggle"><input type="checkbox" id="vdrToggle" onchange="toggleVDR()"><span class="slider-track"></span></label>
    </div>
    <div class="card-body" id="vdrPanel" style="display:none">
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px;flex-wrap:wrap">
        <div class="field" style="margin:0;flex:0 0 auto">
          <label>Velg Ã¥r</label>
          <select id="vdrYear" onchange="renderVDR()" style="font-size:14px;padding:6px 12px">
            <option value="2026">2026 (pre-revenue)</option>
            <option value="2027" selected>2027 (Seed / oppstart)</option>
            <option value="2028">2028</option>
            <option value="2029">2029 (Serie A T1)</option>
            <option value="2030">2030</option>
            <option value="2031">2031</option>
            <option value="2032">2032 (steady state)</option>
            <option value="2033">2033</option>
            <option value="2034">2034</option>
            <option value="2035">2035</option>
          </select>
        </div>
        <button type="button" id="vdrLoadBtn" onclick="loadVDRtoCalc()" style="display:inline-block;background:#1a1a2e;color:white;border:none;padding:10px 24px;font-weight:600;cursor:pointer;border-radius:4px;font-size:13px;font-family:Calibri,sans-serif">â†“ Last inn i kalkulator</button>
        <span id="vdrDiag" style="font-size:10px;color:var(--gray)"></span>
        <div style="font-size:11px;color:var(--gray);flex:1">Ref: <em>02 Economic Tables &amp; Projections</em> (VDR 02.04)</div>
      </div>
      <div class="summary-row" id="vdrKPI" style="grid-template-columns:repeat(6,1fr);margin-bottom:20px"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px" id="vdrGrid1">
        <div>
          <h3 style="font-size:13px;font-weight:700;margin:0 0 8px;color:var(--dark)">Inntekt &amp; Utnyttelse</h3>
          <div id="vdrRevenue"></div>
        </div>
        <div>
          <h3 style="font-size:13px;font-weight:700;margin:0 0 8px;color:var(--dark)">Kostnadsstruktur</h3>
          <div id="vdrCosts"></div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px" id="vdrGrid2">
        <div>
          <h3 style="font-size:13px;font-weight:700;margin:0 0 8px;color:var(--dark)">Kapitalstruktur &amp; Cap Table</h3>
          <div id="vdrCapital"></div>
        </div>
        <div>
          <h3 style="font-size:13px;font-weight:700;margin:0 0 8px;color:var(--dark)">Use of Funds</h3>
          <div id="vdrFunds"></div>
        </div>
      </div>
      <div style="margin-bottom:20px">
        <h3 style="font-size:13px;font-weight:700;margin:0 0 8px;color:var(--dark)">Sensitivitet &amp; Break-even</h3>
        <div id="vdrSensitivity"></div>
      </div>
      <div>
        <h3 style="font-size:13px;font-weight:700;margin:0 0 8px;color:var(--dark)">FlerÃ¥rig Bane (2027â€“2035)</h3>
        <div id="vdrTrajectory"></div>
      </div>
    </div>
  </div>

  <div class="card no-print">
    <div class="card-header"><h2><span class="dot" style="background:var(--red)"></span>Stresstest</h2>
      <label class="toggle"><input type="checkbox" id="stressToggle" onchange="toggleStress();recalculate()"><span class="slider-track"></span></label>
    </div>
    <div class="card-body" id="stressPanel" style="display:none">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:16px">
        <div class="field">
          <label>Forsink inntekter (mnd)</label>
          <input type="number" id="stressDelayMonths" value="0" min="0" max="12" step="1">
        </div>
        <div class="field">
          <label>Reduser inntekter (%)</label>
          <input type="number" id="stressIncomeReduction" value="0" min="0" max="100" step="5">
        </div>
        <div class="field">
          <label>Ã˜k kostnader (%)</label>
          <input type="number" id="stressCostIncrease" value="0" min="0" max="100" step="5">
        </div>
        <div class="field">
          <label>Minimumsbalanse (NOK)</label>
          <input type="number" id="stressMinBalance" value="2000000" step="500000">
        </div>
      </div>
      <div class="otp-detail" id="stressDetail" style="margin-top:8px"></div>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><h2><span class="dot"></span>Likviditetsoversikt</h2></div>
    <div class="card-body">
      <div style="position:relative"><div class="balance-bar-row" id="barChart"></div><div id="minBalLine" style="display:none"></div></div>
      <div class="bar-labels-row" id="barLabels"></div>
      <div id="stressBarSection" style="display:none;margin-top:16px">
        <div style="font-size:12px;font-weight:600;color:var(--red);margin-bottom:4px">âš  Stresstest-scenario</div>
        <div class="balance-bar-row" id="stressBarChart"></div>
        <div class="bar-labels-row" id="stressBarLabels"></div>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-header"><h2><span class="dot"></span>MÃ¥nedlig detaljoversikt</h2></div>
    <div class="card-body"><div class="month-table-wrap"><table class="month-table"><thead><tr id="monthHeaderRow"></tr></thead><tbody id="monthBody"></tbody></table></div></div>
  </div>
  <div class="card" id="stressComparisonCard" style="display:none">
    <div class="card-header"><h2><span class="dot" style="background:var(--red)"></span>Stresstest â€” Sammenligning</h2></div>
    <div class="card-body"><div class="month-table-wrap"><table class="month-table"><thead><tr id="stressHeaderRow"></tr></thead><tbody id="stressBody"></tbody></table></div></div>
  </div>
  <div class="print-footer" style="display:none">Aurelian Manufacturing AS Â· Org.nr 835 679 632 Â· Likviditetskalkulator Â· KONFIDENSIELT Â· Generert <span id="printDate"></span></div>
</div>
<div class="footer no-print"><span>Aurelian Manufacturing AS</span> Â· Likviditetskalkulator Â· Konfidensielt</div>

<script>
const MONTHS = ['Jan','Feb','Mar','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Des'];

/* â•â•â• DATA â•â•â• */
let employees = [{name:'',salary:0,startDate:'',birthYear:null}];
let fixedCosts = [
  {name:'Husleie / lokaler',amount:0,startDate:'',endDate:'',mva:false},
  {name:'Forsikring',amount:0,startDate:'',endDate:'',mva:false},
  {name:'IT / programvare',amount:0,startDate:'',endDate:'',mva:true},
  {name:'Regnskap / revisjon',amount:0,startDate:'',endDate:'',mva:true},
];
let fixedIncome = [{name:'',amount:0,startDate:'',endDate:'',mva:true}];
let varIncomeEntries = [{name:'',date:'',amount:0,mva:true}];
let varEntries = [{name:'',date:'',amount:0,mva:true}];
let loans = [];
let leases = [];
let capitalEntries = [{name:'',date:'',amount:0}];

let manualIB = {2026: 0};
let currentYear = 2026;

/* â•â•â• HELPERS â•â•â• */
function fmt(n) { return n===0?'0':Math.round(n).toLocaleString('no-NO'); }
function fmtK(n) {
  if(Math.abs(n)>=1e6) return (n/1e6).toFixed(1)+'M';
  if(Math.abs(n)>=1e3) return (n/1e3).toFixed(0)+'k';
  return Math.round(n).toString();
}
function ymStr(y,m){return y+'-'+String(m+1).padStart(2,'0');}
function isActive(startDate,endDate,year,month){
  const ym=ymStr(year,month);
  if(startDate&&ym<startDate)return false;
  if(endDate&&ym>endDate)return false;
  return true;
}
function absMonth(ymString){
  if(!ymString)return -Infinity;
  const[y,m]=ymString.split('-').map(Number);
  return y*12+(m-1);
}

const _d=new Date().toLocaleDateString('no-NO',{day:'numeric',month:'long',year:'numeric'});
document.getElementById('todayDate').textContent=_d;
document.getElementById('printDate').textContent=_d;

function updateSliders(){document.getElementById('otpVal').textContent=document.getElementById('otpSlider').value+'%';}
function calcOTP(salary,pct,over7G,G){
  let base=salary*(pct/100);
  if(over7G&&salary>7.1*G){const over=Math.min(salary,12*G)-7.1*G; if(over>0)base+=over*0.18;}
  return base;
}

/* â•â•â• YEAR NAVIGATION â•â•â• */
function changeYear(d){
  const sel=document.getElementById('viewYear');
  const nv=parseInt(sel.value)+d;
  if(sel.querySelector(`option[value="${nv}"]`)){sel.value=nv;onYearChange();}
}
function onYearChange(){
  currentYear=parseInt(document.getElementById('viewYear').value);
  const ib=getYearIB(currentYear);
  document.getElementById('ibInput').value=Math.round(ib);
  const info=document.getElementById('ibInfo');
  if(manualIB.hasOwnProperty(currentYear)){info.style.display='none';}
  else{info.style.display='block';info.textContent=`Beregnet automatisk fra UB ${currentYear-1}`;}
  recalculate();
}
function onIBChange(){
  manualIB[currentYear]=parseFloat(document.getElementById('ibInput').value)||0;
  document.getElementById('ibInfo').style.display='none';
  recalculate();
}
function getYearIB(year){
  if(manualIB.hasOwnProperty(year))return manualIB[year];
  let base=year;
  while(base>2024&&!manualIB.hasOwnProperty(base))base--;
  if(!manualIB.hasOwnProperty(base))return 0;
  let ib=manualIB[base];
  for(let y=base;y<year;y++)ib=computeYearUB(y,ib);
  return ib;
}
function computeYearUB(year,ib){
  const otpPct=parseInt(document.getElementById('otpSlider').value)||2;
  const over7G=document.getElementById('otpOver7G').checked;
  const aga=document.getElementById('agaToggle').checked;
  const G=parseFloat(document.getElementById('gInput').value)||124028;
  const mvaEnabled=document.getElementById('mvaToggle').checked;
  const debtorDays=parseInt(document.getElementById('debtorDays').value)||0;
  const creditorDays=parseInt(document.getElementById('creditorDays').value)||0;
  const debtorShift=Math.ceil(debtorDays/30);
  const creditorShift=Math.ceil(creditorDays/30);

  const pers=calcMonthlyPersonnel(otpPct,over7G,aga,G,year);
  let mFI=calcMonthlyFixed(fixedIncome,year);
  let mFC=calcMonthlyFixed(fixedCosts,year);
  let mVI=monthlyAggDate(varIncomeEntries,year);
  let mV=monthlyAggDate(varEntries,year);
  const mC=monthlyAggDate(capitalEntries,year);
  const la=getAggregatedFinance(loans,year);
  const lea=getAggregatedFinance(leases,year);

  // Apply betalingsbetingelser
  mFI=shiftMonths(mFI,debtorShift);mVI=shiftMonths(mVI,debtorShift);
  mFC=shiftMonths(mFC,creditorShift);mV=shiftMonths(mV,creditorShift);
  if(debtorShift>0){
    const o1=getShiftedFromPrevYear(null,year-1,debtorShift,'fixedIncome');
    const o2=getShiftedFromPrevYear(null,year-1,debtorShift,'varIncome');
    for(let m=0;m<12;m++){mFI[m]+=o1[m];mVI[m]+=o2[m];}
  }
  if(creditorShift>0){
    const o1=getShiftedFromPrevYear(null,year-1,creditorShift,'fixedCost');
    const o2=getShiftedFromPrevYear(null,year-1,creditorShift,'varCost');
    for(let m=0;m<12;m++){mFC[m]+=o1[m];mV[m]+=o2[m];}
  }

  const mvaSettle=mvaEnabled?calcMVASettlement(year):new Array(12).fill(0);
  const mvaD=mvaEnabled?calcMVAMonthly(year):{utg:new Array(12).fill(0),inn:new Array(12).fill(0)};
  const fpResult=calcFeriepenger(year);const fp=fpResult.fp;
  if(fpResult.saved>0){pers[5]=Math.max(0,pers[5]-fpResult.saved);}
  const agaT=calcAGATermin(pers,fp,year);
  const fs=calcForskuddsskatt(year);

  let r=ib;
  for(let m=0;m<12;m++){
    const cashIn=mFI[m]+mVI[m]+mvaD.utg[m]+la.disbursement[m];
    const cashOut=pers[m]+mFC[m]+mV[m]+la.total[m]+lea.total[m]+mvaD.inn[m]+fp[m]+agaT.payments[m]+fs[m];
    r=r+cashIn+mC[m]-cashOut-mvaSettle[m];
  }
  return r;
}

/* â•â•â• EMPLOYEES â•â•â• */
function renderEmployees(){
  const otpPct=parseInt(document.getElementById('otpSlider').value)||2;
  const over7G=document.getElementById('otpOver7G').checked;
  const aga=document.getElementById('agaToggle').checked;
  const G=parseFloat(document.getElementById('gInput').value)||124028;
  const tb=document.getElementById('employeesBody');tb.innerHTML='';
  let tS=0,tO=0,tM=0;
  employees.forEach((e,i)=>{
    const s=parseFloat(e.salary)||0,o=calcOTP(s,otpPct,over7G,G),mn=(s+o)/12;
    tS+=s;tO+=o;tM+=mn;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="text" value="${e.name}" placeholder="Navn" oninput="employees[${i}].name=this.value"></td>
      <td><input type="number" class="num-input" value="${e.salary||''}" step="10000" placeholder="0" oninput="employees[${i}].salary=parseFloat(this.value)||0;updateEmployeeFooter();recalculate()"></td>
      <td><input type="number" value="${e.birthYear||''}" placeholder="Ã…r" min="1940" max="2010" style="width:100%;font-size:12px;padding:4px;text-align:center" oninput="employees[${i}].birthYear=parseInt(this.value)||null;recalculate()"></td>
      <td><input type="month" value="${e.startDate||''}" onchange="employees[${i}].startDate=this.value;recalculate()" style="font-size:12px;padding:4px"></td>
      <td style="text-align:right;color:var(--gray)">${fmt(Math.round(o))}</td>
      <td style="text-align:right;font-weight:600">${fmt(Math.round(mn))}</td>
      <td><button class="btn-remove" onclick="employees.splice(${i},1);renderEmployees();recalculate()">Ã—</button></td>`;
    tb.appendChild(tr);
  });
  document.getElementById('empCountLabel').textContent=employees.length+' ansatte';
  document.getElementById('empSalaryTotal').textContent=fmt(Math.round(tS));
  document.getElementById('empOTPTotal').textContent=fmt(Math.round(tO));
  document.getElementById('empMonthlyTotal').textContent=fmt(Math.round(tM));
}
function updateEmployeeFooter(){
  const otpPct=parseInt(document.getElementById('otpSlider').value)||2;
  const over7G=document.getElementById('otpOver7G').checked;
  const aga=document.getElementById('agaToggle').checked;
  const G=parseFloat(document.getElementById('gInput').value)||124028;
  let tS=0,tO=0,tM=0;
  employees.forEach(e=>{const s=parseFloat(e.salary)||0,o=calcOTP(s,otpPct,over7G,G);tS+=s;tO+=o;tM+=(s+o)/12;});
  document.getElementById('empSalaryTotal').textContent=fmt(Math.round(tS));
  document.getElementById('empOTPTotal').textContent=fmt(Math.round(tO));
  document.getElementById('empMonthlyTotal').textContent=fmt(Math.round(tM));
}
function addEmployee(){employees.push({name:'',salary:0,startDate:'',birthYear:null});renderEmployees();}
function calcMonthlyPersonnel(otpPct,over7G,aga,G,year){
  const pm=new Array(12).fill(0);
  employees.forEach(e=>{
    const s=parseFloat(e.salary)||0;if(!s)return;
    const o=calcOTP(s,otpPct,over7G,G),mn=(s+o)/12;
    for(let m=0;m<12;m++){if(isActive(e.startDate,'',year,m))pm[m]+=mn;}
  });
  return pm;
}

/* â•â•â• FIXED COSTS â•â•â• */
function renderFixed(){
  const tb=document.getElementById('fixedBody');tb.innerHTML='';
  fixedCosts.forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="text" value="${c.name}" oninput="fixedCosts[${i}].name=this.value"></td>
      <td><input type="month" value="${c.startDate||''}" onchange="fixedCosts[${i}].startDate=this.value;recalculate()" style="font-size:12px;padding:4px"></td>
      <td><input type="month" value="${c.endDate||''}" onchange="fixedCosts[${i}].endDate=this.value;recalculate()" style="font-size:12px;padding:4px"></td>
      <td style="text-align:center"><input type="checkbox" ${c.mva?'checked':''} onchange="fixedCosts[${i}].mva=this.checked;recalculate()" style="width:auto;cursor:pointer"></td>
      <td><input type="number" class="num-input" value="${c.amount||''}" step="100" oninput="fixedCosts[${i}].amount=parseFloat(this.value)||0;updateFixedTotal();recalculate()"></td>
      <td><button class="btn-remove" onclick="fixedCosts.splice(${i},1);renderFixed();recalculate()">Ã—</button></td>`;
    tb.appendChild(tr);
  });
  updateFixedTotal();
}
function updateFixedTotal(){document.getElementById('fixedTotal').textContent=fmt(fixedCosts.reduce((s,c)=>s+(parseFloat(c.amount)||0),0));}
function addFixed(){fixedCosts.push({name:'',amount:0,startDate:'',endDate:'',mva:true});renderFixed();}

/* â•â•â• FIXED INCOME â•â•â• */
function renderFixedIncome(){
  const tb=document.getElementById('fixedIncomeBody');tb.innerHTML='';
  fixedIncome.forEach((c,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="text" value="${c.name}" placeholder="f.eks. Fast kundeavtale" oninput="fixedIncome[${i}].name=this.value"></td>
      <td><input type="month" value="${c.startDate||''}" onchange="fixedIncome[${i}].startDate=this.value;recalculate()" style="font-size:12px;padding:4px"></td>
      <td><input type="month" value="${c.endDate||''}" onchange="fixedIncome[${i}].endDate=this.value;recalculate()" style="font-size:12px;padding:4px"></td>
      <td style="text-align:center"><input type="checkbox" ${c.mva?'checked':''} onchange="fixedIncome[${i}].mva=this.checked;recalculate()" style="width:auto;cursor:pointer"></td>
      <td><input type="number" class="num-input" value="${c.amount||''}" step="1000" oninput="fixedIncome[${i}].amount=parseFloat(this.value)||0;updateFixedIncomeTotal();recalculate()"></td>
      <td><button class="btn-remove" onclick="fixedIncome.splice(${i},1);renderFixedIncome();recalculate()">Ã—</button></td>`;
    tb.appendChild(tr);
  });
  updateFixedIncomeTotal();
}
function updateFixedIncomeTotal(){document.getElementById('fixedIncomeTotal').textContent=fmt(fixedIncome.reduce((s,c)=>s+(parseFloat(c.amount)||0),0));}
function addFixedIncome(){fixedIncome.push({name:'',amount:0,startDate:'',endDate:'',mva:true});renderFixedIncome();}

function calcMonthlyFixed(items,year){
  const pm=new Array(12).fill(0);
  items.forEach(c=>{const a=parseFloat(c.amount)||0;for(let m=0;m<12;m++){if(isActive(c.startDate,c.endDate,year,m))pm[m]+=a;}});
  return pm;
}

/* â•â•â• DATE-BASED ENTRIES â•â•â• */
function getEntryArray(t){return t==='varIncome'?varIncomeEntries:t==='capital'?capitalEntries:varEntries;}
function getEntryArrayName(t){return t==='varIncome'?'varIncomeEntries':t==='capital'?'capitalEntries':'varEntries';}
function getEntryBodyId(t){return t==='varIncome'?'varIncomeBody':t==='capital'?'capitalBody':'varBody';}
function getEntryTotalId(t){return t==='varIncome'?'varIncomeTotal':t==='capital'?'capitalTotal':'varTotal';}
function getEntryPlaceholder(t){return t==='varIncome'?'f.eks. Prosjektleveranse':t==='capital'?'f.eks. Seed-runde, tilskudd':'f.eks. Konsulenttimer';}

function renderEntries(type){
  const entries=getEntryArray(type),arrName=getEntryArrayName(type),tb=document.getElementById(getEntryBodyId(type)),ph=getEntryPlaceholder(type);
  const hasMva=(type==='varIncome'||type==='var');
  tb.innerHTML='';
  entries.forEach((e,i)=>{
    const tr=document.createElement('tr');
    const mvaTd=hasMva?`<td style="text-align:center"><input type="checkbox" ${e.mva?'checked':''} onchange="${arrName}[${i}].mva=this.checked;recalculate()" style="width:auto;cursor:pointer"></td>`:'';
    tr.innerHTML=`
      <td><input type="text" value="${e.name}" placeholder="${ph}" oninput="${arrName}[${i}].name=this.value"></td>
      <td><input type="date" value="${e.date||''}" onchange="${arrName}[${i}].date=this.value;recalculate()" style="font-size:13px;padding:6px 8px"></td>
      ${mvaTd}
      <td><input type="number" class="num-input" value="${e.amount||''}" step="1000" placeholder="0" oninput="${arrName}[${i}].amount=parseFloat(this.value)||0;updateEntryTotal('${type}');recalculate()"></td>
      <td><button class="btn-remove" onclick="${arrName}.splice(${i},1);renderEntries('${type}');recalculate()">Ã—</button></td>`;
    tb.appendChild(tr);
  });
  updateEntryTotal(type);
}
function updateEntryTotal(type){document.getElementById(getEntryTotalId(type)).textContent=fmt(getEntryArray(type).reduce((s,e)=>s+(parseFloat(e.amount)||0),0));}
function addEntry(type){
  const hasMva=(type==='varIncome'||type==='var');
  getEntryArray(type).push({name:'',date:'',amount:0,...(hasMva?{mva:true}:{})});
  renderEntries(type);
}

function monthlyAggDate(entries,year){
  const arr=new Array(12).fill(0);
  entries.forEach(e=>{if(!e.date)return;const a=parseFloat(e.amount)||0,p=e.date.split('-'),ey=parseInt(p[0]),em=parseInt(p[1])-1;if(ey===year&&em>=0&&em<12)arr[em]+=a;});
  return arr;
}

/* â•â•â• LOANS & LEASING â•â•â• */
function addLoan(){loans.push({name:'Nytt lÃ¥n',amount:0,rate:7.5,termYears:8,graceMonths:0,startDate:''});renderLoans();recalculate();}
function removeLoan(i){loans.splice(i,1);renderLoans();recalculate();}
function addLease(){leases.push({name:'Ny leasing',amount:0,rate:5.0,termYears:5,graceMonths:0,startDate:''});renderLeases();recalculate();}
function removeLease(i){leases.splice(i,1);renderLeases();recalculate();}

function renderFinanceCards(items,containerId,arrName,removeFn,updateFn){
  const c=document.getElementById(containerId);c.innerHTML='';
  items.forEach((item,i)=>{
    const d=document.createElement('div');d.className='loan-card';
    d.innerHTML=`
      <div class="loan-card-header">
        <input type="text" value="${item.name}" placeholder="Beskrivelse" oninput="${arrName}[${i}].name=this.value">
        <button class="btn-remove" onclick="${removeFn}(${i})" style="font-size:20px">Ã—</button>
      </div>
      <div class="loan-grid">
        <div class="field"><label>${arrName==='loans'?'LÃ¥nesum':'Leasingsum'} (NOK)</label><input type="number" value="${item.amount||''}" step="100000" placeholder="0" oninput="${arrName}[${i}].amount=parseFloat(this.value)||0;${updateFn}(${i});recalculate()"></div>
        <div class="field"><label>Rente (% p.a.)</label><input type="number" value="${item.rate}" step="0.1" min="0" max="30" oninput="${arrName}[${i}].rate=parseFloat(this.value)||0;${updateFn}(${i});recalculate()"></div>
        <div class="field"><label>LÃ¸petid (Ã¥r)</label><input type="number" value="${item.termYears}" step="1" min="1" max="30" oninput="${arrName}[${i}].termYears=parseInt(this.value)||1;${updateFn}(${i});recalculate()"></div>
        <div class="field"><label>Avdragsfri (mnd)</label><input type="number" value="${item.graceMonths}" step="1" min="0" max="60" oninput="${arrName}[${i}].graceMonths=parseInt(this.value)||0;${updateFn}(${i});recalculate()"></div>
        <div class="field"><label>Utbetales fra</label><input type="month" value="${item.startDate||''}" onchange="${arrName}[${i}].startDate=this.value;${updateFn}(${i});recalculate()"></div>
      </div>
      <div class="loan-summary-row" id="${arrName}Sum${i}"></div>`;
    c.appendChild(d);
    window[updateFn](i);
  });
}
function renderLoans(){renderFinanceCards(loans,'loansContainer','loans','removeLoan','updateLoanSummary');}
function renderLeases(){renderFinanceCards(leases,'leasesContainer','leases','removeLease','updateLeaseSummary');}

function calcAnnuity(P,r,n){return r===0?P/Math.max(n,1):P*r/(1-Math.pow(1+r,-n));}

function calcFinanceTotalInterest(item){
  const T=item.termYears*12,g=item.graceMonths||0,p=Math.max(T-g,1),r=(item.rate/100)/12,a=calcAnnuity(item.amount,r,p);
  let b=item.amount,ti=0;
  for(let m=0;m<T;m++){const int=b*r;ti+=int;if(m>=g)b=Math.max(b-(a-int),0);}
  return ti;
}

function updateFinanceSummary(items,prefix,i){
  const el=document.getElementById(prefix+'Sum'+i);if(!el)return;
  const item=items[i];if(!item||!item.amount){el.innerHTML='';return;}
  const T=item.termYears*12,g=item.graceMonths||0,p=Math.max(T-g,1),r=(item.rate/100)/12;
  const a=calcAnnuity(item.amount,r,p),fi=item.amount*r,ti=calcFinanceTotalInterest(item);
  el.innerHTML=`
    <div class="ls-item"><span>Mnd. annuitet</span><span class="ls-val">${fmt(Math.round(a))}</span></div>
    <div class="ls-item"><span>FÃ¸rste mnd. rente</span><span class="ls-val">${fmt(Math.round(fi))}</span></div>
    <div class="ls-item"><span>Start</span><span class="ls-val">${item.startDate||'Ikke satt'}</span></div>
    <div class="ls-item"><span>Total rente</span><span class="ls-val">${fmt(Math.round(ti))}</span></div>
    ${g>0?`<div class="ls-item"><span class="loan-badge grace">Avdragsfri ${g} mnd</span></div>`:''}`;
}
function updateLoanSummary(i){updateFinanceSummary(loans,'loans',i);}
function updateLeaseSummary(i){updateFinanceSummary(leases,'leases',i);}

function calcFinanceForYear(item,year){
  const interest=new Array(12).fill(0),principal=new Array(12).fill(0),total=new Array(12).fill(0),disbursement=new Array(12).fill(0);
  if(!item.amount||item.amount<=0||!item.startDate)return{interest,principal,total,disbursement};
  const T=item.termYears*12,g=item.graceMonths||0,p=Math.max(T-g,1),r=(item.rate/100)/12;
  const a=calcAnnuity(item.amount,r,p);
  const sA=absMonth(item.startDate),yA=year*12;
  // Disbursement: loan amount paid out in start month
  if(sA>=yA&&sA<yA+12){disbursement[sA-yA]=item.amount;}
  let b=item.amount,gr=g;
  for(let am=sA;am<yA+12;am++){
    if(am>=sA+T||b<=0.01)break;
    const int=b*r;let pr=0;
    if(gr>0){gr--;}else{pr=Math.min(a-int,b);b=Math.max(b-pr,0);}
    if(am>=yA&&am<yA+12){const m=am-yA;interest[m]=int;principal[m]=pr;total[m]=int+pr;}
  }
  return{interest,principal,total,disbursement};
}
function getAggregatedFinance(items,year){
  const interest=new Array(12).fill(0),principal=new Array(12).fill(0),total=new Array(12).fill(0),disbursement=new Array(12).fill(0);
  items.forEach(item=>{const f=calcFinanceForYear(item,year);for(let m=0;m<12;m++){interest[m]+=f.interest[m];principal[m]+=f.principal[m];total[m]+=f.total[m];disbursement[m]+=f.disbursement[m];}});
  return{interest,principal,total,disbursement};
}

/* â•â•â• MVA CALCULATION â•â•â• */

/**
 * Compute monthly utgÃ¥ende MVA (on income) and inngÃ¥ende MVA (on costs) for a year.
 * Returns { utg: [12], inn: [12] }
 */
function calcMVAMonthly(year) {
  const utg = new Array(12).fill(0); // MVA collected on income
  const inn = new Array(12).fill(0); // MVA paid on costs

  // Fixed income with MVA
  fixedIncome.forEach(c => {
    if (!c.mva) return;
    const amt = (parseFloat(c.amount) || 0) * 0.25;
    for (let m = 0; m < 12; m++) { if (isActive(c.startDate, c.endDate, year, m)) utg[m] += amt; }
  });

  // Variable income with MVA
  varIncomeEntries.forEach(e => {
    if (!e.mva || !e.date) return;
    const p = e.date.split('-'), ey = parseInt(p[0]), em = parseInt(p[1]) - 1;
    if (ey === year && em >= 0 && em < 12) utg[em] += (parseFloat(e.amount) || 0) * 0.25;
  });

  // Fixed costs with MVA
  fixedCosts.forEach(c => {
    if (!c.mva) return;
    const amt = (parseFloat(c.amount) || 0) * 0.25;
    for (let m = 0; m < 12; m++) { if (isActive(c.startDate, c.endDate, year, m)) inn[m] += amt; }
  });

  // Variable costs with MVA
  varEntries.forEach(e => {
    if (!e.mva || !e.date) return;
    const p = e.date.split('-'), ey = parseInt(p[0]), em = parseInt(p[1]) - 1;
    if (ey === year && em >= 0 && em < 12) inn[em] += (parseFloat(e.amount) || 0) * 0.25;
  });

  return { utg, inn };
}

/**
 * Compute MVA settlement schedule for a year.
 * Norwegian bimonthly terms:
 *   Term 1: Jan+Feb â†’ paid April
 *   Term 2: Mar+Apr â†’ paid June
 *   Term 3: May+Jun â†’ paid August
 *   Term 4: Jul+Aug â†’ paid October
 *   Term 5: Sep+Oct â†’ paid December
 *   Term 6: Nov+Dec â†’ paid February NEXT year
 *
 * Returns array[12] of settlement amounts (positive = pay to state, negative = refund)
 * Also includes previous year's Term 6 in February.
 */
function calcMVASettlement(year) {
  const settlement = new Array(12).fill(0);
  const mva = calcMVAMonthly(year);

  // Terms within this year (Term 1-5 paid in this year)
  const terms = [[0,1,3],[2,3,5],[4,5,7],[6,7,9],[8,9,11]];
  terms.forEach(([m1,m2,payM]) => {
    settlement[payM] = (mva.utg[m1] + mva.utg[m2]) - (mva.inn[m1] + mva.inn[m2]);
  });

  // Previous year's Term 6 (Nov+Dec) â†’ paid February (m=1) of this year
  const prevMva = calcMVAMonthly(year - 1);
  settlement[1] += (prevMva.utg[10] + prevMva.utg[11]) - (prevMva.inn[10] + prevMva.inn[11]);

  return settlement;
}

/**
 * Get this year's Term 6 carry-forward (Nov+Dec MVA that will be settled in Feb next year).
 */
function getMVATerm6Carry(year) {
  const mva = calcMVAMonthly(year);
  return (mva.utg[10] + mva.utg[11]) - (mva.inn[10] + mva.inn[11]);
}

/* â•â•â• FERIEPENGER â•â•â• */
/**
 * Norwegian vacation pay: 12% of previous year's gross salary, paid in June.
 * First year of employment: no payout (no previous year accrual).
 * Returns array[12] with June payout for the given year.
 */
function calcFeriepenger(year) {
  const fp = new Array(12).fill(0);
  const empty = {fp, payout:0, saved:0, accrual:0, accrualMonthly:0, details:[]};
  if (!document.getElementById('ferieToggle').checked) return empty;
  const prevYear = year - 1;
  let totalPayout = 0, totalSaved = 0, totalAccrual = 0;
  const details = [];

  employees.forEach(emp => {
    if (!emp.salary || emp.salary <= 0) return;
    const s = emp.salary;
    const rate = (emp.birthYear && (year - emp.birthYear) >= 60) ? 0.143 : 0.12;

    // Payout: based on prev year accrual
    let prevMonths = 0;
    for (let m = 0; m < 12; m++) { if (isActive(emp.startDate, '', prevYear, m)) prevMonths++; }
    let empPayout = 0, empSaved = 0;
    if (prevMonths > 0) {
      empPayout = s * (prevMonths / 12) * rate;
      // June: save gross salary (OTP continues, AGA handled separately)
      if (isActive(emp.startDate, '', year, 5)) {
        empSaved = s / 12;
      }
    }

    // Accrual this year â†’ payout next June
    let thisMonths = 0;
    for (let m = 0; m < 12; m++) { if (isActive(emp.startDate, '', year, m)) thisMonths++; }
    const empAccrual = s * (thisMonths / 12) * rate;

    totalPayout += empPayout;
    totalSaved += empSaved;
    totalAccrual += empAccrual;
    if (empPayout > 0 || empAccrual > 0) {
      details.push({name: emp.name||'(uten navn)', rate, payout: empPayout, saved: empSaved, accrual: empAccrual, over60: rate===0.143});
    }
  });

  fp[5] = totalPayout; // Pure feriepenger, no AGA

  return {fp, payout: totalPayout, saved: totalSaved, accrual: totalAccrual, accrualMonthly: totalAccrual/12, details};
}

/* â•â•â• AGA TERMINBETALING â•â•â• */
/**
 * Norwegian employer's national insurance (AGA, 14.1%).
 * Bimonthly payment terms:
 *   Term 1: Jan+Feb â†’ paid 15. March
 *   Term 2: Mar+Apr â†’ paid 15. May
 *   Term 3: May+Jun â†’ paid 15. July
 *   Term 4: Jul+Aug â†’ paid 15. September
 *   Term 5: Sep+Oct â†’ paid 15. November
 *   Term 6: Nov+Dec â†’ paid 15. January NEXT year
 *
 * AGA basis = salary+OTP (persMonthly) + feriepenger (ferieMonthly)
 * Returns { payments:[12], monthly:[12], term6Carry:number }
 */
function calcAGATermin(persMonthly, ferieMonthly, year) {
  const noAGA = {payments:new Array(12).fill(0), monthly:new Array(12).fill(0), term6Carry:0};
  if (!document.getElementById('agaToggle').checked) return noAGA;

  const monthly = new Array(12).fill(0);
  const payments = new Array(12).fill(0);

  // Monthly AGA accrual
  for (let m = 0; m < 12; m++) {
    monthly[m] = (persMonthly[m] + ferieMonthly[m]) * 0.141;
  }

  // Map to bimonthly payment months (month after term end)
  const terms = [[0,1,2],[2,3,4],[4,5,6],[6,7,8],[8,9,10]];
  terms.forEach(([m1,m2,payM]) => {
    payments[payM] = monthly[m1] + monthly[m2];
  });

  // Previous year's Term 6 (Nov+Dec) â†’ paid January this year
  const otpPct = parseInt(document.getElementById('otpSlider').value) || 2;
  const over7G = document.getElementById('otpOver7G').checked;
  const G = parseFloat(document.getElementById('gInput').value) || 124028;
  const prevPers = calcMonthlyPersonnel(otpPct, over7G, false, G, year - 1);
  const prevFerie = calcFeriepenger(year - 1);
  // Apply June reduction for prev year too
  if (prevFerie.saved > 0) prevPers[5] = Math.max(0, prevPers[5] - prevFerie.saved);
  const prevNovAGA = (prevPers[10] + prevFerie.fp[10]) * 0.141;
  const prevDecAGA = (prevPers[11] + prevFerie.fp[11]) * 0.141;
  payments[0] += prevNovAGA + prevDecAGA;

  // Term 6 carry = Nov+Dec this year â†’ January next year
  const term6Carry = monthly[10] + monthly[11];

  return {payments, monthly, term6Carry};
}

/* â•â•â• BETALINGSBETINGELSER â•â•â• */
/**
 * Shift an array of monthly values forward by N months (simulating payment delay).
 * Values shifted beyond December are lost for this year (they appear in next year).
 */
function shiftMonths(arr, months) {
  if (months <= 0) return [...arr];
  const shifted = new Array(12).fill(0);
  for (let m = 0; m < 12; m++) {
    const target = m + months;
    if (target < 12) shifted[target] += arr[m];
    // Values pushed beyond Dec are lost (handled by carry-forward in next year)
  }
  return shifted;
}

/**
 * Get values from previous year that were shifted into this year.
 * E.g., Nov income with 2 month delay â†’ arrives Jan this year.
 */
function getShiftedFromPrevYear(items, prevYear, shiftMonths, type) {
  if (shiftMonths <= 0) return new Array(12).fill(0);
  const overflow = new Array(12).fill(0);
  let prevArr;
  if (type === 'fixedIncome') prevArr = calcMonthlyFixed(fixedIncome, prevYear);
  else if (type === 'fixedCost') prevArr = calcMonthlyFixed(fixedCosts, prevYear);
  else if (type === 'varIncome') prevArr = monthlyAggDate(varIncomeEntries, prevYear);
  else if (type === 'varCost') prevArr = monthlyAggDate(varEntries, prevYear);
  else return overflow;

  for (let m = 0; m < 12; m++) {
    const target = m + shiftMonths;
    if (target >= 12 && target < 12 + shiftMonths) {
      const overflowMonth = target - 12;
      if (overflowMonth < 12) overflow[overflowMonth] += prevArr[m];
    }
  }
  return overflow;
}

/* â•â•â• FORSKUDDSSKATT â•â•â• */
/**
 * Norwegian corporate tax: 22% of estimated profit.
 * Paid quarterly: Feb 15, Apr 15, Sep 15, Nov 15.
 * Returns array[12].
 */
function calcForskuddsskatt(year) {
  const fs = new Array(12).fill(0);
  if (!document.getElementById('forskuddsskattToggle').checked) return fs;
  const basis = parseFloat(document.getElementById('forskuddsskattBasis').value) || 0;
  if (basis <= 0) return fs;
  const annual = basis * 0.22;
  const quarterly = annual / 4;
  fs[1] = quarterly;  // Feb
  fs[3] = quarterly;  // Apr
  fs[8] = quarterly;  // Sep
  fs[10] = quarterly; // Nov
  return fs;
}

/* â•â•â• SAVE / LOAD â•â•â• */
function saveData() {
  const data = {
    version: 2,
    savedAt: new Date().toISOString(),
    config: {
      currentYear,
      manualIB,
      ib: parseFloat(document.getElementById('ibInput').value) || 0,
      G: parseFloat(document.getElementById('gInput').value) || 124028,
      otpPct: parseInt(document.getElementById('otpSlider').value) || 2,
      otpOver7G: document.getElementById('otpOver7G').checked,
      agaToggle: document.getElementById('agaToggle').checked,
      mvaToggle: document.getElementById('mvaToggle').checked,
      ferieToggle: document.getElementById('ferieToggle').checked,
      forskuddsskattToggle: document.getElementById('forskuddsskattToggle').checked,
      forskuddsskattBasis: parseFloat(document.getElementById('forskuddsskattBasis').value) || 0,
      debtorDays: parseInt(document.getElementById('debtorDays').value) || 0,
      creditorDays: parseInt(document.getElementById('creditorDays').value) || 0,
      stressToggle: document.getElementById('stressToggle').checked,
      stressDelayMonths: parseInt(document.getElementById('stressDelayMonths').value) || 0,
      stressIncomeReduction: parseInt(document.getElementById('stressIncomeReduction').value) || 0,
      stressCostIncrease: parseInt(document.getElementById('stressCostIncrease').value) || 0,
      stressMinBalance: parseInt(document.getElementById('stressMinBalance').value) || 2000000,
      vdrToggle: document.getElementById('vdrToggle').checked,
      vdrYear: document.getElementById('vdrYear').value,
    },
    employees, fixedCosts, fixedIncome,
    varIncomeEntries, varEntries, loans, leases, capitalEntries
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `likviditet_${currentYear}_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function loadData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.config) {
        manualIB = data.config.manualIB || {2026: 0};
        currentYear = data.config.currentYear || 2026;
        document.getElementById('viewYear').value = currentYear;
        document.getElementById('ibInput').value = data.config.ib || 0;
        document.getElementById('gInput').value = data.config.G || 124028;
        document.getElementById('otpSlider').value = data.config.otpPct || 2;
        document.getElementById('otpOver7G').checked = !!data.config.otpOver7G;
        document.getElementById('agaToggle').checked = data.config.agaToggle !== false;
        document.getElementById('mvaToggle').checked = data.config.mvaToggle !== false;
        document.getElementById('ferieToggle').checked = data.config.ferieToggle !== false;
        document.getElementById('forskuddsskattToggle').checked = !!data.config.forskuddsskattToggle;
        document.getElementById('forskuddsskattBasis').value = data.config.forskuddsskattBasis || 0;
        document.getElementById('debtorDays').value = data.config.debtorDays || 0;
        document.getElementById('creditorDays').value = data.config.creditorDays || 0;
        document.getElementById('stressToggle').checked = !!data.config.stressToggle;
        document.getElementById('stressDelayMonths').value = data.config.stressDelayMonths || 0;
        document.getElementById('stressIncomeReduction').value = data.config.stressIncomeReduction || 0;
        document.getElementById('stressCostIncrease').value = data.config.stressCostIncrease || 0;
        document.getElementById('stressMinBalance').value = data.config.stressMinBalance || 2000000;
        if(data.config.vdrToggle){document.getElementById('vdrToggle').checked=true;}
        if(data.config.vdrYear){document.getElementById('vdrYear').value=data.config.vdrYear;}
        toggleStress();
        toggleVDR();
        toggleForskuddsskatt();
      }
      if (data.employees) employees = data.employees;
      if (data.fixedCosts) fixedCosts = data.fixedCosts;
      if (data.fixedIncome) fixedIncome = data.fixedIncome;
      if (data.varIncomeEntries) varIncomeEntries = data.varIncomeEntries;
      if (data.varEntries) varEntries = data.varEntries;
      if (data.loans) loans = data.loans;
      if (data.leases) leases = data.leases;
      if (data.capitalEntries) capitalEntries = data.capitalEntries;
      renderAll(); updateSliders(); onYearChange();
      alert('Data lastet inn!');
    } catch(err) { alert('Kunne ikke lese filen: ' + err.message); }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function toggleForskuddsskatt() {
  document.getElementById('forskuddsskattFields').style.display =
    document.getElementById('forskuddsskattToggle').checked ? 'block' : 'none';
}
function toggleStress() {
  const on = document.getElementById('stressToggle').checked;
  document.getElementById('stressPanel').style.display = on ? 'block' : 'none';
  document.getElementById('stressComparisonCard').style.display = on ? 'block' : 'none';
  document.getElementById('stressBarSection').style.display = on ? 'block' : 'none';
}

/* â•â•â• VDR FINANCIAL MODEL â€” DATA FROM MASTER DOC â•â•â• */
const VDR = {
  assumptions: {
    hoursPerYear: 8760, hourlyRate: 3000, customerProgramThreshold: 0.45,
    customerProgramSplit: 0.50, adminFTE: 4, adminSalary: 1400000,
    opsSalary: 1100000, facilityLease: 5200000, opexPerCNC: 150000,
    shopBaseDepr: 1075000, cncCost: 10000000, deprLife: 8, debtRate: 0.075,
    seedDebtPerCNC: 5000000, serieADebtPerCNC: 7000000, shopBaseDebt: 4300000
  },
  varCostCurve: {2027:0.13,2028:0.13,2029:0.1175,2030:0.105,2031:0.0925,2032:0.08,2033:0.08,2034:0.08,2035:0.08},
  years: {
    2026: {cncAvg:0,cncEOY:0,util:0,opsFTE:0,adminFTE:3,revenue:0,totalCost:0,grossProfit:0,custProg:0,aurelianProfit:0,funding:'PreSeed',facilityActive:false,
      staffTimeline:[{period:'H1',ops:0,admin:2,total:2,source:'Founders'},{period:'H2',ops:0,admin:3,total:3,source:'Founders'}],
      capitalEvents:[{desc:'PreSeed closed',amount:5000000}]},
    2027: {cncAvg:5,cncEOY:5,util:0.20,opsFTE:6,adminFTE:4,revenue:10900000,totalCost:13400000,grossProfit:-2500000,custProg:0,aurelianProfit:-2500000,funding:'Seed',facilityActive:true,
      seedCNC:5,serieACNC:0,totalDebt:29300000,finCost:2200000,
      staffTimeline:[{period:'Q1-Q2',ops:4,admin:4,total:8,source:'Seed (training)'},{period:'Q3+',ops:6,admin:4,total:10,source:'Seed'}],
      capitalEvents:[{desc:'Seed equity',amount:51300000},{desc:'Seed bank debt',amount:29300000}],
      note:'H2 only â€” production starts Aug 2027'},
    2028: {cncAvg:5,cncEOY:5,util:0.375,opsFTE:6,adminFTE:4,revenue:49300000,totalCost:34100000,grossProfit:15200000,custProg:0,aurelianProfit:15200000,funding:'Operations',facilityActive:true,
      seedCNC:5,serieACNC:0,totalDebt:29300000,finCost:2200000},
    2029: {cncAvg:12,cncEOY:15,util:0.425,opsFTE:10,adminFTE:4,revenue:134000000,totalCost:61100000,grossProfit:72900000,custProg:0,aurelianProfit:72900000,funding:'Serie A',facilityActive:true,
      seedCNC:5,serieACNC:10,totalDebt:99300000,finCost:7450000,
      capitalEvents:[{desc:'Serie A equity (T1+T2)',amount:30000000},{desc:'Serie A bank debt (T1+T2)',amount:70000000}]},
    2030: {cncAvg:17,cncEOY:20,util:0.475,opsFTE:13,adminFTE:4,revenue:212000000,totalCost:80200000,grossProfit:131800000,custProg:0,aurelianProfit:131800000,funding:'Serie A T3',facilityActive:true,
      seedCNC:5,serieACNC:15,totalDebt:134300000,finCost:10070000,
      capitalEvents:[{desc:'Serie A equity (T3)',amount:15000000},{desc:'Serie A bank debt (T3)',amount:35000000}]},
    2031: {cncAvg:20,cncEOY:20,util:0.525,opsFTE:16,adminFTE:4,revenue:276000000,totalCost:92800000,grossProfit:183200000,custProg:16400000,aurelianProfit:166800000,funding:'Self-funded',facilityActive:true,
      seedCNC:5,serieACNC:15,totalDebt:134300000,finCost:10070000},
    2032: {cncAvg:20,cncEOY:20,util:0.575,opsFTE:20,adminFTE:4,revenue:302000000,totalCost:92400000,grossProfit:209600000,custProg:27300000,aurelianProfit:182300000,funding:'Self-funded',facilityActive:true,
      seedCNC:5,serieACNC:15,totalDebt:134300000,finCost:10070000},
    2033: {cncAvg:22,cncEOY:22,util:0.60,opsFTE:20,adminFTE:4,revenue:347000000,totalCost:98000000,grossProfit:249000000,custProg:42000000,aurelianProfit:207000000,funding:'Self-funded',facilityActive:true,
      seedCNC:5,serieACNC:17,totalDebt:148300000,finCost:11120000},
    2034: {cncAvg:24,cncEOY:24,util:0.625,opsFTE:20,adminFTE:4,revenue:394000000,totalCost:103800000,grossProfit:290200000,custProg:57600000,aurelianProfit:232600000,funding:'Self-funded',facilityActive:true,
      seedCNC:5,serieACNC:19,totalDebt:162300000,finCost:12170000},
    2035: {cncAvg:25,cncEOY:25,util:0.65,opsFTE:20,adminFTE:4,revenue:427000000,totalCost:107200000,grossProfit:319800000,custProg:72000000,aurelianProfit:247800000,funding:'Self-funded',facilityActive:true,
      seedCNC:5,serieACNC:20,totalDebt:169300000,finCost:12700000}
  },
  capTable: {
    founding: [{name:'Holen Industrier AS',pct:53.125},{name:'Quality Group Invest AS',pct:31.875},{name:'STAH Invest AS',pct:10.0},{name:'Roadcode AS',pct:5.0}],
    postPreSeed: [{name:'Holen',pct:44.27},{name:'Quality Group',pct:26.56},{name:'STAH',pct:8.33},{name:'Roadcode',pct:4.17},{name:'PreSeed investors',pct:16.67}],
    postSeed: [{name:'Holen',pct:31.74},{name:'Quality Group',pct:19.05},{name:'STAH',pct:5.97},{name:'Roadcode',pct:2.99},{name:'PreSeed investors',pct:11.95},{name:'Seed investors',pct:28.30}],
    postSerieA: [{name:'Holen',pct:26.90},{name:'Quality Group',pct:16.14},{name:'STAH',pct:5.06},{name:'Roadcode',pct:2.53},{name:'PreSeed investors',pct:10.12},{name:'Seed investors',pct:23.98},{name:'Serie A investors',pct:15.25}]
  },
  fundingRounds: {
    preSeed: {equity:5,preMoney:25,postMoney:30,debt:0,total:5},
    seed: {equity:51.3,preMoney:130,postMoney:181.3,debt:29.3,total:80.6},
    serieA: {equity:45,preMoney:250,postMoney:295,debt:105,total:150}
  },
  seedUseOfFunds: [
    {cat:'CNC-maskiner (5 Ã— 5.0M EK)',amount:25.0,source:'Equity'},
    {cat:'CNC-maskiner (5 Ã— 5.0M gjeld)',amount:25.0,source:'Bank'},
    {cat:'Shop base utstyr',amount:8.6,source:'Equity'},
    {cat:'Shop base gjeld (50%)',amount:4.3,source:'Bank'},
    {cat:'Pre-revenue bemanning (janâ€“jul 2027)',amount:4.7,source:'Equity'},
    {cat:'Facility setup & commissioning',amount:3.0,source:'Equity'},
    {cat:'Facility lease pre-revenue (Q3â€“Q4)',amount:2.3,source:'Equity'},
    {cat:'Sertifiseringer (AS9100, AQAP, ISO)',amount:2.0,source:'Equity'},
    {cat:'Buffer',amount:10.0,source:'Equity'}
  ],
  sensitivity: [
    {util:0.15,rev:78.8,varCost:6.3,totalCost:73.8,ebit:5.0,margin:0.06},
    {util:0.20,rev:105.1,varCost:8.4,totalCost:75.9,ebit:29.2,margin:0.28},
    {util:0.30,rev:157.7,varCost:12.6,totalCost:80.1,ebit:77.6,margin:0.49},
    {util:0.40,rev:210.2,varCost:16.8,totalCost:84.3,ebit:125.9,margin:0.60},
    {util:0.45,rev:236.5,varCost:18.9,totalCost:86.4,ebit:150.1,margin:0.63},
    {util:0.50,rev:262.8,varCost:21.0,totalCost:88.5,ebit:174.3,margin:0.66},
    {util:0.60,rev:315.4,varCost:25.2,totalCost:92.7,ebit:222.7,margin:0.71},
    {util:0.65,rev:341.6,varCost:27.3,totalCost:94.8,ebit:246.8,margin:0.72}
  ],
  breakeven: [
    {cnc:3,fixed:22.5,beRev:25.9,beUtil:0.33,comment:'Tight'},
    {cnc:5,fixed:27.7,beRev:31.8,beUtil:0.24,comment:'Achievable in months'},
    {cnc:10,fixed:43.7,beRev:48.6,beUtil:0.18,comment:'Post tranche 1'},
    {cnc:15,fixed:56.7,beRev:62.2,beUtil:0.16,comment:'Post tranche 2'},
    {cnc:20,fixed:67.5,beRev:73.4,beUtil:0.14,comment:'Very low threshold'}
  ]
};

function toggleVDR(){
  const on=document.getElementById('vdrToggle').checked;
  document.getElementById('vdrPanel').style.display=on?'block':'none';
  if(on)renderVDR();
}

function renderVDR(){
  const yr=parseInt(document.getElementById('vdrYear').value);
  const d=VDR.years[yr];
  if(!d)return;
  const a=VDR.assumptions;
  const fN=(v,u)=>typeof v==='number'?(v>=1000000?((v/1000000).toFixed(1).replace('.0','')+' M'):(v>=1000?Math.round(v).toLocaleString('nb-NO'):v))+(u||''):'â€”';
  const fM=v=>typeof v==='number'?(v/1000000).toFixed(1)+' MNOK':'â€”';
  const fP=v=>typeof v==='number'?Math.round(v*100)+'%':'â€”';

  // KPI cards
  const kpi=document.getElementById('vdrKPI');
  const kpis=[
    {label:'CNC-maskiner',value:d.cncEOY,sub:d.cncAvg!==d.cncEOY?`snitt ${d.cncAvg}`:yr===2026?'Ingen':'Hele Ã¥ret'},
    {label:'Utnyttelse',value:fP(d.util),sub:d.util===0?'Pre-revenue':`av ${a.hoursPerYear.toLocaleString('nb-NO')} timer`},
    {label:'Omsetning',value:fM(d.revenue),sub:d.revenue===0?'â€”':`${a.hourlyRate.toLocaleString('nb-NO')} NOK/time`},
    {label:'Resultat',value:fM(d.aurelianProfit),sub:d.revenue>0?`Margin ${Math.round(d.aurelianProfit/d.revenue*100)}%`:'â€”'},
    {label:'Ansatte',value:(d.opsFTE+d.adminFTE),sub:`${d.opsFTE} ops + ${d.adminFTE} admin`},
    {label:'Fase',value:d.funding,sub:yr<=2026?'Pre-revenue':yr===2027?'Oppstart':yr>=2032?'Steady state':'Vekst'}
  ];
  kpi.innerHTML=kpis.map(k=>`<div class="summary-card"><div style="font-size:10px;text-transform:uppercase;letter-spacing:0.5px;color:var(--gray)">${k.label}</div><div style="font-size:22px;font-weight:700;color:var(--dark);margin:4px 0">${k.value}</div><div style="font-size:11px;color:var(--gray)">${k.sub}</div></div>`).join('');

  // Revenue & Utilization
  const revEl=document.getElementById('vdrRevenue');
  if(d.revenue>0){
    const revenuePerCNC=a.hoursPerYear*d.util*a.hourlyRate;
    const varPct=VDR.varCostCurve[yr]||0.08;
    const varCost=d.revenue*varPct;
    const persOps=d.opsFTE*a.opsSalary;
    const persAdmin=d.adminFTE*a.adminSalary;
    revEl.innerHTML=`
      <table class="cost-table" style="font-size:12px"><tbody>
      <tr><td>CNC (snitt)</td><td class="r">${d.cncAvg}</td></tr>
      <tr><td>Utnyttelse</td><td class="r">${fP(d.util)}</td></tr>
      <tr><td>Timer/CNC/Ã¥r</td><td class="r">${Math.round(a.hoursPerYear*d.util).toLocaleString('nb-NO')}</td></tr>
      <tr><td>Omsetning/CNC</td><td class="r">${fM(revenuePerCNC)}</td></tr>
      <tr style="font-weight:700;border-top:2px solid var(--dark)"><td>Total omsetning</td><td class="r">${fM(d.revenue)}</td></tr>
      <tr><td>Variable kostnader (${Math.round(varPct*100)}%)</td><td class="r">${fM(varCost)}</td></tr>
      <tr><td>Customer Program</td><td class="r">${d.custProg>0?fM(d.custProg):'â€”'}</td></tr>
      <tr style="font-weight:700;border-top:2px solid var(--dark)"><td>Aurelian resultat</td><td class="r">${fM(d.aurelianProfit)}</td></tr>
      </tbody></table>`;
  } else {
    revEl.innerHTML=`<div style="color:var(--gray);font-size:13px;padding:16px">Ingen inntekter i ${yr}. ${yr===2026?'Pre-revenue fase â€” se Use of Funds.':'Produksjon starter Aug 2027.'}</div>`;
  }

  // Cost structure
  const costEl=document.getElementById('vdrCosts');
  if(d.totalCost>0){
    const varPct=VDR.varCostCurve[yr]||0.08;
    const persOps=d.opsFTE*a.opsSalary;
    const persAdmin=d.adminFTE*a.adminSalary;
    const deprCNC=d.cncEOY*a.cncCost/a.deprLife;
    const finCost=d.finCost||0;
    const facility=d.facilityActive?a.facilityLease:0;
    const varCost=d.revenue*varPct;
    const opex=d.cncEOY*a.opexPerCNC;
    const rows=[
      {cat:'LÃ¸nn operatÃ¸rer',val:persOps,pct:persOps/d.totalCost},
      {cat:'LÃ¸nn admin/salg',val:persAdmin,pct:persAdmin/d.totalCost},
      {cat:'Avskrivning CNC',val:deprCNC,pct:deprCNC/d.totalCost},
      {cat:'Avskrivning shop base',val:a.shopBaseDepr,pct:a.shopBaseDepr/d.totalCost},
      {cat:'Finanskostnad',val:finCost,pct:finCost/d.totalCost},
      {cat:'Leie lokaler',val:facility,pct:facility/d.totalCost},
      {cat:`Variable kostn. (${Math.round(varPct*100)}%)`,val:varCost,pct:varCost/d.totalCost},
      {cat:'Ã˜vrig drift',val:opex,pct:opex/d.totalCost}
    ].filter(r=>r.val>0);
    const colors=['#F50537','#2B2B2B','#6B6B6B','#999','#c41e3a','#4a4a4a','#888','#bbb'];
    costEl.innerHTML=`
      <table class="cost-table" style="font-size:12px"><tbody>
      ${rows.map((r,i)=>`<tr><td><span style="display:inline-block;width:10px;height:10px;border-radius:2px;background:${colors[i]};margin-right:6px;vertical-align:middle"></span>${r.cat}</td><td class="r">${fM(r.val)}</td><td class="r" style="color:var(--gray);width:50px">${Math.round(r.pct*100)}%</td></tr>`).join('')}
      <tr style="font-weight:700;border-top:2px solid var(--dark)"><td>Sum kostnader</td><td class="r">${fM(d.totalCost)}</td><td class="r">100%</td></tr>
      </tbody></table>`;
  } else {
    const preCost=(d.adminFTE||2)*a.adminSalary;
    costEl.innerHTML=`<div style="color:var(--gray);font-size:13px;padding:16px">Pre-revenue drift: ${d.adminFTE||2} ansatte Ã— ${fN(a.adminSalary)} = ${fM(preCost)}/Ã¥r. Finansiert av founders.</div>`;
  }

  // Capital structure
  const capEl=document.getElementById('vdrCapital');
  let capStage='founding';
  if(yr>=2029)capStage='postSerieA';else if(yr>=2027)capStage='postSeed';else if(yr>=2026)capStage='postPreSeed';
  const capData=VDR.capTable[capStage];
  const roundInfo=yr>=2029?VDR.fundingRounds.serieA:yr>=2027?VDR.fundingRounds.seed:VDR.fundingRounds.preSeed;
  const foundersPct=capData.filter(c=>!c.name.includes('investor')).reduce((s,c)=>s+c.pct,0);
  capEl.innerHTML=`
    <table class="cost-table" style="font-size:12px"><tbody>
    ${capData.map(c=>`<tr><td>${c.name}</td><td class="r" style="font-weight:${c.name.includes('investor')?'400':'600'}">${c.pct.toFixed(2)}%</td></tr>`).join('')}
    <tr style="font-weight:700;border-top:2px solid var(--dark)"><td>Founders total</td><td class="r">${foundersPct.toFixed(1)}%</td></tr>
    </tbody></table>
    <div style="margin-top:10px;padding:10px;background:var(--light-gray);border-radius:6px;font-size:11px">
      <strong>Siste runde:</strong> ${fM(roundInfo.equity*1e6)} EK + ${fM(roundInfo.debt*1e6)} gjeld = ${fM(roundInfo.total*1e6)} total<br>
      Pre-money: ${fM(roundInfo.preMoney*1e6)} Â· Post-money: ${fM(roundInfo.postMoney*1e6)}
    </div>`;

  // Use of Funds
  const fundsEl=document.getElementById('vdrFunds');
  if(yr<=2027){
    const items=VDR.seedUseOfFunds;
    const eqTotal=items.filter(i=>i.source==='Equity').reduce((s,i)=>s+i.amount,0);
    const dbtTotal=items.filter(i=>i.source==='Bank').reduce((s,i)=>s+i.amount,0);
    fundsEl.innerHTML=`
      <table class="cost-table" style="font-size:12px"><tbody>
      ${items.map(i=>`<tr><td>${i.cat}</td><td class="r">${i.amount.toFixed(1)} M</td><td style="font-size:10px;color:var(--gray)">${i.source}</td></tr>`).join('')}
      <tr style="font-weight:700;border-top:2px solid var(--dark)"><td>EK deployed</td><td class="r">${eqTotal.toFixed(1)} M</td><td></td></tr>
      <tr style="font-weight:700"><td>Inkl. gjeld</td><td class="r">${(eqTotal+dbtTotal).toFixed(1)} M</td><td></td></tr>
      </tbody></table>`;
  } else if(yr>=2029&&yr<=2030){
    fundsEl.innerHTML=`
      <table class="cost-table" style="font-size:12px"><tbody>
      <tr><td colspan="3" style="font-weight:600">Serie A â€” milestone-baserte transjer</td></tr>
      <tr><td>Tranche 1 (5 CNC)</td><td class="r">15.0 M EK + 35.0 M gjeld</td><td style="font-size:10px;color:var(--gray)">Trigger: close + demand</td></tr>
      <tr><td>Tranche 2 (5 CNC)</td><td class="r">15.0 M EK + 35.0 M gjeld</td><td style="font-size:10px;color:var(--gray)">T1 > 30% util.</td></tr>
      <tr><td>Tranche 3 (5 CNC)</td><td class="r">15.0 M EK + 35.0 M gjeld</td><td style="font-size:10px;color:var(--gray)">T2 > 30% util.</td></tr>
      <tr style="font-weight:700;border-top:2px solid var(--dark)"><td>Total Serie A</td><td class="r">45.0 M EK + 105.0 M gjeld = 150.0 M</td><td></td></tr>
      </tbody></table>`;
  } else {
    fundsEl.innerHTML=`<div style="color:var(--gray);font-size:13px;padding:16px">Selvfinansiert vekst fra ~${yr>=2032?'2030':'operasjonell cash flow'}. Ingen ytterligere EK-runder planlagt.</div>`;
  }

  // Sensitivity (always show for context)
  const sensEl=document.getElementById('vdrSensitivity');
  const currentUtil=d.util;
  sensEl.innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div>
      <div style="font-size:11px;font-weight:600;margin-bottom:6px">Utilization-sensitivitet (20 CNC, 8% var, fÃ¸r Customer Program)</div>
      <table class="cost-table" style="font-size:11px"><thead><tr><th>Util.</th><th class="r">Omsetn.</th><th class="r">Totalkost.</th><th class="r">EBIT</th><th class="r">Margin</th></tr></thead><tbody>
      ${VDR.sensitivity.map(s=>`<tr${Math.abs(s.util-currentUtil)<0.01?' style="background:#fff3cd;font-weight:600"':''}><td>${Math.round(s.util*100)}%</td><td class="r">${s.rev.toFixed(1)}</td><td class="r">${s.totalCost.toFixed(1)}</td><td class="r">${s.ebit.toFixed(1)}</td><td class="r">${Math.round(s.margin*100)}%</td></tr>`).join('')}
      </tbody></table>
      <div style="font-size:10px;color:var(--gray);margin-top:4px">Alle tall i MNOK. Gul rad = valgt Ã¥rs utnyttelse.</div>
    </div>
    <div>
      <div style="font-size:11px;font-weight:600;margin-bottom:6px">Break-even per CNC-konfigurasjon</div>
      <table class="cost-table" style="font-size:11px"><thead><tr><th>CNC</th><th class="r">Faste kost.</th><th class="r">BE-omstn.</th><th class="r">BE-util.</th><th>Kommentar</th></tr></thead><tbody>
      ${VDR.breakeven.map(b=>`<tr${b.cnc===d.cncEOY?' style="background:#fff3cd;font-weight:600"':''}><td>${b.cnc}</td><td class="r">${b.fixed.toFixed(1)}</td><td class="r">${b.beRev.toFixed(1)}</td><td class="r">${Math.round(b.beUtil*100)}%</td><td style="font-size:10px;color:var(--gray)">${b.comment}</td></tr>`).join('')}
      </tbody></table>
      <div style="font-size:10px;color:var(--gray);margin-top:4px">Alle tall i MNOK. Gul rad = valgt Ã¥rs konfigurasjon.</div>
    </div></div>`;

  // Trajectory mini-table
  const trajEl=document.getElementById('vdrTrajectory');
  const trajYears=[2027,2028,2029,2030,2031,2032,2033,2034,2035];
  trajEl.innerHTML=`
    <div class="month-table-wrap"><table class="cost-table" style="font-size:11px"><thead><tr><th>Parameter</th>${trajYears.map(y=>`<th class="r"${y===yr?' style="background:#fff3cd"':''}>${y}</th>`).join('')}</tr></thead><tbody>
    <tr><td>CNC (EOY)</td>${trajYears.map(y=>`<td class="r"${y===yr?' style="background:#fff3cd"':''}>${VDR.years[y].cncEOY}</td>`).join('')}</tr>
    <tr><td>Utnyttelse</td>${trajYears.map(y=>`<td class="r"${y===yr?' style="background:#fff3cd"':''}>${Math.round(VDR.years[y].util*100)}%</td>`).join('')}</tr>
    <tr><td>Omsetning (MNOK)</td>${trajYears.map(y=>`<td class="r"${y===yr?' style="background:#fff3cd"':''}>${(VDR.years[y].revenue/1e6).toFixed(0)}</td>`).join('')}</tr>
    <tr><td>Totalkostnad</td>${trajYears.map(y=>`<td class="r"${y===yr?' style="background:#fff3cd"':''}>${(VDR.years[y].totalCost/1e6).toFixed(0)}</td>`).join('')}</tr>
    <tr><td>Customer Program</td>${trajYears.map(y=>`<td class="r"${y===yr?' style="background:#fff3cd"':''}>${VDR.years[y].custProg>0?(VDR.years[y].custProg/1e6).toFixed(0):'â€”'}</td>`).join('')}</tr>
    <tr style="font-weight:700;border-top:2px solid var(--dark)"><td>Aurelian resultat</td>${trajYears.map(y=>`<td class="r"${y===yr?' style="background:#fff3cd"':''}>${(VDR.years[y].aurelianProfit/1e6).toFixed(0)}</td>`).join('')}</tr>
    <tr><td>Ansatte</td>${trajYears.map(y=>`<td class="r"${y===yr?' style="background:#fff3cd"':''}>${VDR.years[y].opsFTE+VDR.years[y].adminFTE}</td>`).join('')}</tr>
    </tbody></table></div>
    <div style="font-size:10px;color:var(--gray);margin-top:4px">Akkumulert Aurelian-resultat 2027â€“2035: ~1 254 MNOK Â· Ref: <em>02 Economic Tables & Projections</em> (VDR 02.04)</div>`;
}

/* â•â•â• LOAD VDR â†’ CALCULATOR â•â•â• */
function showVDRMsg(msg,bg,color){
  var old=document.getElementById('vdrMsg');if(old)old.remove();
  var b=document.createElement('div');b.id='vdrMsg';
  b.style.cssText='padding:12px 16px;border-radius:6px;font-size:13px;font-weight:600;margin-bottom:12px;background:'+bg+';color:'+color;
  b.textContent=msg;
  var p=document.getElementById('vdrPanel');
  if(p&&p.children.length>1)p.insertBefore(b,p.children[1]);
  setTimeout(function(){if(b.parentNode){b.style.opacity='0';b.style.transition='opacity 0.5s';setTimeout(function(){b.remove();},600);}},5000);
}

function loadVDRtoCalc(){
  try{
  var yr=parseInt(document.getElementById('vdrYear').value);
  var d=VDR.years[yr];
  var a=VDR.assumptions;
  if(!d){showVDRMsg('Ingen VDR-data for '+yr,'#f8d7da','#721c24');return;}

  currentYear=yr;
  document.getElementById('viewYear').value=yr;

  // Employees
  employees=[];
  var i;
  for(i=0;i<d.opsFTE;i++){
    var sd=yr===2027?(i<4?yr+'-01':yr+'-07'):yr+'-01';
    employees.push({name:'OperatÃ¸r '+(i+1),salary:a.opsSalary,startDate:sd,birthYear:null});
  }
  var adminNames=['CEO / AndrÃ© Tandberg','VP BD / Tore Ausland','CFO / Henrik S. StrÃ¸m','Admin'];
  for(i=0;i<d.adminFTE;i++){
    employees.push({name:adminNames[i]||('Admin '+(i+1)),salary:a.adminSalary,startDate:yr+'-01',birthYear:null});
  }

  // Fixed costs
  fixedCosts=[];
  var startProd=yr===2027?yr+'-07':yr+'-01';
  var startRev=yr===2027?yr+'-08':yr+'-01';
  if(d.facilityActive){fixedCosts.push({name:'Leie lokaler (Norbygg)',amount:Math.round(a.facilityLease/12),startDate:startProd,endDate:'',mva:false});}
  var opx=d.cncEOY*a.opexPerCNC;
  if(opx>0){fixedCosts.push({name:'Ã˜vrig drift (IT, forsikring, forbruk)',amount:Math.round(opx/12),startDate:startProd,endDate:'',mva:true});}
  var dep=d.cncEOY*(a.cncCost/a.deprLife);
  if(dep>0){fixedCosts.push({name:'Avskrivning CNC ('+d.cncEOY+' maskiner)',amount:Math.round(dep/12),startDate:startProd,endDate:'',mva:false});}
  if(d.facilityActive){fixedCosts.push({name:'Avskrivning shop base',amount:Math.round(a.shopBaseDepr/12),startDate:startProd,endDate:'',mva:false});}
  if(d.revenue>0){
    var vp=VDR.varCostCurve[yr]||0.08;
    var am=yr===2027?5:12;
    var mv=Math.round(d.revenue*vp/am);
    fixedCosts.push({name:'Variable kostn. ('+Math.round(vp*100)+'%)',amount:mv,startDate:startRev,endDate:'',mva:true});
  }

  // Fixed income
  fixedIncome=[];
  if(d.revenue>0){
    var am2=yr===2027?5:12;
    var mr=Math.round(d.revenue/am2);
    fixedIncome.push({name:'CNC-produksjon ('+d.cncAvg+' CNC, '+Math.round(d.util*100)+'%)',amount:mr,startDate:startRev,endDate:'',mva:true});
  }

  varEntries=[];
  varIncomeEntries=[];

  // Loans
  loans=[];
  if(d.totalDebt&&d.totalDebt>0){
    var sd2=d.seedCNC?d.seedCNC*a.seedDebtPerCNC+a.shopBaseDebt:0;
    var sa2=d.serieACNC?d.serieACNC*a.serieADebtPerCNC:0;
    if(sd2>0){loans.push({name:'Seed bankgjeld (CNC + shop base)',amount:sd2,rate:a.debtRate*100,termYears:8,graceMonths:0,startDate:'2027-06'});}
    if(sa2>0){loans.push({name:'Serie A bankgjeld (CNC)',amount:sa2,rate:a.debtRate*100,termYears:8,graceMonths:0,startDate:'2029-01'});}
  }

  // Capital
  capitalEntries=[];
  if(d.capitalEvents){
    for(var j=0;j<d.capitalEvents.length;j++){
      var ev=d.capitalEvents[j];
      if(ev.desc.toLowerCase().indexOf('debt')>=0)continue;
      capitalEntries.push({name:ev.desc,amount:ev.amount,date:yr+'-01'});
    }
  }
  if(capitalEntries.length===0){capitalEntries.push({name:'',amount:0,date:''});}

  leases=[];

  var ibVal=yr===2027?5000000:0;
  manualIB[yr]=ibVal;
  document.getElementById('ibInput').value=ibVal;

  renderAll();
  updateSliders();
  recalculate();

  showVDRMsg('VDR '+yr+' lastet: '+employees.length+' ansatte, '+fixedCosts.length+' kostnader, '+fixedIncome.length+' inntekter, '+loans.length+' lÃ¥n','#d4edda','#155724');
  }catch(err){
    showVDRMsg('FEIL: '+err.message,'#f8d7da','#721c24');
  }
}
window.loadVDRtoCalc=loadVDRtoCalc;
window.showVDRMsg=showVDRMsg;


/* â•â•â• MAIN RECALCULATE â•â•â• */
function recalculate(){
  const year=currentYear,ib=parseFloat(document.getElementById('ibInput').value)||0;
  const otpPct=parseInt(document.getElementById('otpSlider').value)||2;
  const over7G=document.getElementById('otpOver7G').checked;
  const aga=document.getElementById('agaToggle').checked;
  const G=parseFloat(document.getElementById('gInput').value)||124028;

  const persPerMonth=calcMonthlyPersonnel(otpPct,over7G,aga,G,year);
  let empDetails=[];
  employees.forEach(emp=>{
    const s=parseFloat(emp.salary)||0;if(!s)return;
    const o=calcOTP(s,otpPct,over7G,G),mn=(s+o)/12;
    empDetails.push({name:emp.name||'(uten navn)',sal:s,otp:o,monthly:mn,start:emp.startDate||'Ikke satt'});
  });
  let empRows='';
  empDetails.forEach(e=>{empRows+=`<tr><td>${e.name}</td><td style="text-align:right">${fmt(Math.round(e.sal))}</td><td style="text-align:center;color:var(--gray);font-size:12px">${e.start}</td><td style="text-align:right">${fmt(Math.round(e.otp))}</td><td style="text-align:right;font-weight:600">${fmt(Math.round(e.monthly))}</td></tr>`;});
  const persTotal=persPerMonth.reduce((a,b)=>a+b,0);
  document.getElementById('personnelSummary').innerHTML=empDetails.length>0?`
    <table class="cost-table"><thead><tr><th>Ansatt</th><th class="r">LÃ¸nn/Ã¥r</th><th style="text-align:center">Start</th><th class="r">OTP/Ã¥r</th><th class="r">LÃ¸nn+OTP/mnd</th></tr></thead>
    <tbody>${empRows}</tbody>
    <tfoot><tr><td>${empDetails.length} ansatte</td><td></td><td></td><td></td><td style="text-align:right;font-weight:700">${fmt(Math.round(persTotal/12))}</td></tr></tfoot></table>
    ${aga?'<div style="font-size:11px;color:var(--gray);margin-top:6px">AGA (14,1%) beregnes separat â€” betales terminvis annenhver mÃ¥ned.</div>':''}`:'<div style="color:var(--gray);font-size:13px">Ingen ansatte lagt til</div>';
  document.getElementById('personnelDetail').innerHTML=`7,1G = ${fmt(Math.round(7.1*G))} Â· 12G = ${fmt(Math.round(12*G))} Â· OTP-sats: ${otpPct}%${over7G?' + 18% over 7,1G':''}`;

  const mVarIncome=monthlyAggDate(varIncomeEntries,year);
  const mFixedIncome=calcMonthlyFixed(fixedIncome,year);
  const mCapital=monthlyAggDate(capitalEntries,year);
  const mVar=monthlyAggDate(varEntries,year);
  const mFixCost=calcMonthlyFixed(fixedCosts,year);
  const loanAgg=getAggregatedFinance(loans,year);
  const leaseAgg=getAggregatedFinance(leases,year);

  // Feriepenger
  const ferieResult = calcFeriepenger(year);
  const feriePenger = ferieResult.fp;
  const ferieTotal = feriePenger.reduce((a,b)=>a+b,0);

  // June: reduce personnel cost (salary replaced by feriepenger during vacation)
  if (ferieResult.saved > 0) {
    persPerMonth[5] = Math.max(0, persPerMonth[5] - ferieResult.saved);
  }

  // AGA termin (bimonthly payments, calculated on salary+OTP+feriepenger basis)
  const agaResult = calcAGATermin(persPerMonth, feriePenger, year);
  const agaPayments = agaResult.payments;

  // Betalingsbetingelser
  const debtorDays = parseInt(document.getElementById('debtorDays').value) || 0;
  const creditorDays = parseInt(document.getElementById('creditorDays').value) || 0;
  const debtorShift = Math.ceil(debtorDays / 30);
  const creditorShift = Math.ceil(creditorDays / 30);

  // Apply payment delay to income (shift forward)
  let mFixedIncomeShifted = shiftMonths(mFixedIncome, debtorShift);
  let mVarIncomeShifted = shiftMonths(mVarIncome, debtorShift);
  // Add overflow from previous year
  if (debtorShift > 0) {
    const ovFI = getShiftedFromPrevYear(null, year-1, debtorShift, 'fixedIncome');
    const ovVI = getShiftedFromPrevYear(null, year-1, debtorShift, 'varIncome');
    for (let m=0;m<12;m++) { mFixedIncomeShifted[m]+=ovFI[m]; mVarIncomeShifted[m]+=ovVI[m]; }
  }

  // Apply payment delay to costs (shift forward)
  let mFixCostShifted = shiftMonths(mFixCost, creditorShift);
  let mVarShifted = shiftMonths(mVar, creditorShift);
  if (creditorShift > 0) {
    const ovFC = getShiftedFromPrevYear(null, year-1, creditorShift, 'fixedCost');
    const ovVC = getShiftedFromPrevYear(null, year-1, creditorShift, 'varCost');
    for (let m=0;m<12;m++) { mFixCostShifted[m]+=ovFC[m]; mVarShifted[m]+=ovVC[m]; }
  }

  const mIn=mVarIncomeShifted.map((v,m)=>v+mFixedIncomeShifted[m]);

  // Betalingsbetingelser info
  const betInfo=document.getElementById('betTermInfo');
  if(debtorDays>0||creditorDays>0){
    betInfo.style.display='block';
    betInfo.innerHTML=`${debtorDays>0?`Kundeinntekter forskyves ${debtorShift} mnd. `:''}${creditorDays>0?`LeverandÃ¸rkostnader forskyves ${creditorShift} mnd.`:''}`;
  } else { betInfo.style.display='none'; }

  // Forskuddsskatt
  const forskuddsskatt = calcForskuddsskatt(year);

  // MVA
  const mvaEnabled = document.getElementById('mvaToggle').checked;
  const mvaSettle = mvaEnabled ? calcMVASettlement(year) : new Array(12).fill(0);
  const mvaData = mvaEnabled ? calcMVAMonthly(year) : {utg:new Array(12).fill(0),inn:new Array(12).fill(0)};
  const mvaUtgArr = mvaData.utg;
  const mvaInnArr = mvaData.inn;

  // Finance summary cards
  const lts=document.getElementById('loanTotalSummary');
  if(loans.length>0){const ti=loanAgg.interest.reduce((a,b)=>a+b,0),tp=loanAgg.principal.reduce((a,b)=>a+b,0);lts.innerHTML=`<div style="display:flex;gap:24px;padding:12px 16px;background:var(--light-gray);border-radius:6px;font-size:13px;"><div><span style="color:var(--gray);font-size:11px;text-transform:uppercase;letter-spacing:0.5px">Renter ${year}</span><br><strong>${fmt(Math.round(ti))}</strong></div><div><span style="color:var(--gray);font-size:11px;text-transform:uppercase;letter-spacing:0.5px">Avdrag ${year}</span><br><strong>${fmt(Math.round(tp))}</strong></div><div><span style="color:var(--gray);font-size:11px;text-transform:uppercase;letter-spacing:0.5px">Sum lÃ¥n ${year}</span><br><strong>${fmt(Math.round(ti+tp))}</strong></div></div>`;}else{lts.innerHTML='';}
  const lls=document.getElementById('leaseTotalSummary');
  if(leases.length>0){const ti=leaseAgg.interest.reduce((a,b)=>a+b,0),tp=leaseAgg.principal.reduce((a,b)=>a+b,0);lls.innerHTML=`<div style="display:flex;gap:24px;padding:12px 16px;background:var(--light-gray);border-radius:6px;font-size:13px;"><div><span style="color:var(--gray);font-size:11px;text-transform:uppercase;letter-spacing:0.5px">Renter ${year}</span><br><strong>${fmt(Math.round(ti))}</strong></div><div><span style="color:var(--gray);font-size:11px;text-transform:uppercase;letter-spacing:0.5px">Avdrag ${year}</span><br><strong>${fmt(Math.round(tp))}</strong></div><div><span style="color:var(--gray);font-size:11px;text-transform:uppercase;letter-spacing:0.5px">Sum leasing ${year}</span><br><strong>${fmt(Math.round(ti+tp))}</strong></div></div>`;}else{lls.innerHTML='';}

  // MVA detail
  if(mvaEnabled){
    const totUtg=mvaUtgArr.reduce((a,b)=>a+b,0),totInn=mvaInnArr.reduce((a,b)=>a+b,0);
    const totSettle=mvaSettle.reduce((a,b)=>a+b,0);
    const t6carry=getMVATerm6Carry(year);
    document.getElementById('mvaDetail').innerHTML=`Utg. MVA ${year}: <strong>${fmt(Math.round(totUtg))}</strong> Â· Inng. MVA: <strong>${fmt(Math.round(totInn))}</strong> Â· Netto oppgjÃ¸r: <strong>${fmt(Math.round(totSettle))}</strong>${t6carry!==0?` Â· Term 6 â†’ feb ${year+1}: <strong>${fmt(Math.round(t6carry))}</strong>`:''}`;
    document.getElementById('mvaTermInfo').style.display='';
  } else {
    document.getElementById('mvaDetail').innerHTML='MVA-beregning deaktivert';
    document.getElementById('mvaTermInfo').style.display='none';
  }

  // Table header
  const hdr=document.getElementById('monthHeaderRow');
  hdr.innerHTML='<th style="text-align:left">Post</th>';
  MONTHS.forEach(m=>{hdr.innerHTML+=`<th>${m} ${year}</th>`;});
  hdr.innerHTML+='<th style="background:var(--accent)">Totalt</th>';

  const tb=document.getElementById('monthBody');tb.innerHTML='';
  function addRow(label,vals,cls){
    const tr=document.createElement('tr');if(cls)tr.className=cls;
    const tot=vals.reduce((a,b)=>a+b,0);let c=`<td>${label}</td>`;
    vals.forEach(v=>{c+=`<td${v<0?' class="negative-val"':''}>${fmt(Math.round(v))}</td>`;});
    c+=`<td${tot<0?' class="negative-val"':''}><strong>${fmt(Math.round(tot))}</strong></td>`;
    tr.innerHTML=c;tb.appendChild(tr);
  }

  // Balance calc â€” full cash flow model
  let bals=[],running=ib,outArr=[],inArr=[];
  for(let m=0;m<12;m++){
    const cashIn=mIn[m]+mvaUtgArr[m]+loanAgg.disbursement[m];
    const cashOut=persPerMonth[m]+mFixCostShifted[m]+mVarShifted[m]+loanAgg.total[m]+leaseAgg.total[m]+mvaInnArr[m]+feriePenger[m]+agaPayments[m]+forskuddsskatt[m];
    inArr.push(cashIn);
    outArr.push(cashOut);
    const open=running;
    running=open+cashIn+mCapital[m]-cashOut-mvaSettle[m];
    bals.push({open,close:running});
  }

  const ibTr=document.createElement('tr');ibTr.className='row-balance';
  let ic='<td>InngÃ¥ende balanse</td>';ic+=`<td><strong>${fmt(Math.round(ib))}</strong></td>`;
  for(let m=1;m<12;m++){const v=bals[m].open;ic+=`<td${v<0?' class="negative-val"':''}><strong>${fmt(Math.round(v))}</strong></td>`;}
  ic+='<td></td>';ibTr.innerHTML=ic;tb.appendChild(ibTr);

  let sp=document.createElement('tr');sp.innerHTML='<td colspan="14" style="padding:4px;border:none;background:white"></td>';tb.appendChild(sp);
  addRow(mvaEnabled?'Faste inntekter (ex MVA)':'Faste inntekter',mFixedIncomeShifted);
  addRow(mvaEnabled?'Variable inntekter (ex MVA)':'Variable inntekter',mVarIncomeShifted);
  if(mvaEnabled){addRow('+ UtgÃ¥ende MVA (25%)',mvaUtgArr);}
  const hasLoanDisb=loanAgg.disbursement.some(v=>v>0);
  if(hasLoanDisb){addRow('LÃ¥neutbetaling (mottatt)',loanAgg.disbursement);}
  addRow('Sum innbetalinger',inArr,'row-section');
  const capTotal=mCapital.reduce((a,b)=>a+b,0);
  if(capTotal>0){sp=document.createElement('tr');sp.innerHTML='<td colspan="14" style="padding:2px;border:none;background:white"></td>';tb.appendChild(sp);addRow('Kapitalinnhenting / emisjoner',mCapital,'row-section');}
  sp=document.createElement('tr');sp.innerHTML='<td colspan="14" style="padding:2px;border:none;background:white"></td>';tb.appendChild(sp);
  addRow('Personalkostnad (lÃ¸nn+OTP)',persPerMonth);
  if(ferieTotal>0){addRow('Feriepenger utbetalt (juni)',feriePenger);}
  const agaTotal=agaPayments.reduce((a,b)=>a+b,0);
  if(aga&&agaTotal>0){addRow('AGA terminbetaling (14,1%)',agaPayments);}
  addRow(mvaEnabled?'Faste kostnader (ex MVA)':'Faste kostnader',mFixCostShifted);
  addRow(mvaEnabled?'Variable kostnader (ex MVA)':'Variable kostnader',mVarShifted);
  if(mvaEnabled){addRow('+ InngÃ¥ende MVA (25%)',mvaInnArr);}
  if(loans.length>0){addRow('Renter (lÃ¥n)',loanAgg.interest);addRow('Avdrag (lÃ¥n)',loanAgg.principal);}
  if(leases.length>0){addRow('Renter (leasing)',leaseAgg.interest);addRow('Avdrag (leasing)',leaseAgg.principal);}
  const fsTotal=forskuddsskatt.reduce((a,b)=>a+b,0);
  if(fsTotal>0){addRow('Forskuddsskatt (22%)',forskuddsskatt);}
  addRow('Sum utbetalinger',outArr,'row-section');
  if(mvaEnabled){
    const mvaRefund=mvaSettle.map(v=>v<0?-v:0); // positive = money back from state
    const mvaPay=mvaSettle.map(v=>v>0?v:0); // positive = money to state
    const hasRefund=mvaRefund.some(v=>v>0);
    const hasPay=mvaPay.some(v=>v>0);
    sp=document.createElement('tr');sp.innerHTML='<td colspan="14" style="padding:2px;border:none;background:white"></td>';tb.appendChild(sp);
    if(hasRefund) addRow('âœ“ MVA tilgode fra staten',mvaRefund,'row-mva-refund');
    if(hasPay) addRow('â†’ MVA betaling til staten',mvaPay,'row-mva-pay');
  }
  // Net = inflows + capital - outflows - mva settlement
  const netArr=inArr.map((v,m)=>v+mCapital[m]-outArr[m]-mvaSettle[m]);
  addRow('Netto kontantstrÃ¸m',netArr);
  const closing=bals.map(b=>b.close);
  // UB row with optional min-balance breach highlighting
  const stressActive=document.getElementById('stressToggle').checked;
  const ubMinBal=stressActive?(parseInt(document.getElementById('stressMinBalance').value)||0):0;
  const ubTr=document.createElement('tr');ubTr.className='row-balance';
  let ubC='<td>UtgÃ¥ende balanse</td>';
  closing.forEach(v=>{const breach=ubMinBal>0&&v<ubMinBal;ubC+=`<td${breach?' class="breach-cell"':''}${v<0&&!breach?' class="negative-val"':''}><strong>${fmt(Math.round(v))}</strong></td>`;});
  ubC+=`<td><strong>${fmt(Math.round(closing[11]))}</strong></td>`;
  ubTr.innerHTML=ubC;tb.appendChild(ubTr);

  // Feriepenger accrual running balance (pure feriepenger obligation, no AGA)
  if(document.getElementById('ferieToggle').checked && (ferieResult.accrual>0 || ferieResult.payout>0)){
    const prevObligation=ferieResult.payout; // what we owe from last year (paid in June)
    const monthlyAccrual=ferieResult.accrualMonthly; // this year's monthly buildup
    const ferieAccrualBal=[];
    for(let m=0;m<12;m++){
      let bal=prevObligation + monthlyAccrual*(m+1);
      if(m>=5) bal-=ferieResult.payout; // June payout discharges prev year obligation
      ferieAccrualBal.push(bal);
    }
    sp=document.createElement('tr');sp.innerHTML='<td colspan="14" style="padding:2px;border:none;background:white"></td>';tb.appendChild(sp);
    const faTr=document.createElement('tr');faTr.className='row-ferie-accrual';
    let faC='<td>ðŸ“‹ Feriepenger-forpliktelse</td>';
    ferieAccrualBal.forEach(v=>{faC+=`<td>${fmt(Math.round(v))}</td>`;});
    faC+=`<td><strong>${fmt(Math.round(ferieAccrualBal[11]))}</strong></td>`;
    faTr.innerHTML=faC;tb.appendChild(faTr);
  }

  // AGA accrual running balance (bimonthly: accrues monthly, paid every 2 months)
  if(aga && agaTotal>0){
    const agaMonthly=agaResult.monthly;
    // Prev year Term 6 carry: owed at start of year, paid in January
    const prevYearPers=calcMonthlyPersonnel(otpPct,over7G,false,G,year-1);
    const prevYearFerie=calcFeriepenger(year-1);
    if(prevYearFerie.saved>0)prevYearPers[5]=Math.max(0,prevYearPers[5]-prevYearFerie.saved);
    const prevT6=(prevYearPers[10]+prevYearFerie.fp[10]+prevYearPers[11]+prevYearFerie.fp[11])*0.141;
    const agaAccrualBal=[];
    let agaRunning=prevT6; // start with prev year T6 obligation
    for(let m=0;m<12;m++){
      agaRunning+=agaMonthly[m]; // accrue this month
      agaRunning-=agaPayments[m]; // pay if termin month
      agaAccrualBal.push(agaRunning);
    }
    const agaTr=document.createElement('tr');agaTr.className='row-aga-accrual';
    let agaC='<td>ðŸ“‹ AGA-forpliktelse</td>';
    agaAccrualBal.forEach(v=>{agaC+=`<td>${fmt(Math.round(v))}</td>`;});
    agaC+=`<td><strong>${fmt(Math.round(agaAccrualBal[11]))}</strong></td>`;
    agaTr.innerHTML=agaC;tb.appendChild(agaTr);
  }

  // Summary boxes
  const totIn=inArr.reduce((a,b)=>a+b,0),totCap=mCapital.reduce((a,b)=>a+b,0),totOut=outArr.reduce((a,b)=>a+b,0);
  const totMvaSettle=mvaSettle.reduce((a,b)=>a+b,0);
  const final=closing[11],avgOut=totOut/12;
  document.getElementById('sumIB').textContent=fmt(Math.round(ib));
  const ibSub=document.getElementById('sumIBsub');
  ibSub.textContent=manualIB.hasOwnProperty(currentYear)?'':`Fra UB ${currentYear-1}`;
  document.getElementById('sumInflows').textContent=fmt(Math.round(totIn));
  document.getElementById('sumCapital').textContent=fmt(Math.round(totCap));
  document.getElementById('sumOutflows').textContent=fmt(Math.round(totOut+(totMvaSettle>0?totMvaSettle:0)));
  document.getElementById('sumUB').textContent=fmt(Math.round(final));
  document.getElementById('sumUB').className='s-value'+(final<0?' negative-val':'');
  const st=document.getElementById('sumStatus');
  if(final<0)st.innerHTML='<span class="status-dot red"></span>Negativ likviditet';
  else if(final<avgOut*2)st.innerHTML='<span class="status-dot yellow"></span>Stram likviditet';
  else st.innerHTML='<span class="status-dot green"></span>God likviditet';
  document.getElementById('ubBox').className='summary-box '+(final<0?'red':final<avgOut*2?'neutral':'green');

  // Cash runway
  const monthlyBurn=outArr.reduce((a,b)=>a+b,0)/12;
  const monthlyNet=netArr.reduce((a,b)=>a+b,0)/12;
  // Find first month where balance goes negative
  let runwayMonths=null;
  if(monthlyNet<0){
    // Project forward from current UB
    let projected=final;
    let mCount=0;
    while(projected>0&&mCount<60){projected+=monthlyNet;mCount++;}
    if(mCount<60)runwayMonths=12+mCount; // months from Jan this year
  }
  const runwayEl=document.getElementById('sumRunway');
  const runwaySub=document.getElementById('runwaySub');
  const runwayBox=document.getElementById('runwayBox');
  if(monthlyBurn<=0){
    runwayEl.textContent='âˆž';runwaySub.textContent='Ingen utbetalinger';
    runwayBox.style.borderColor='var(--green)';
  } else if(final<=0){
    runwayEl.textContent='0 mnd';runwaySub.innerHTML='<span class="status-dot red"></span>Negativ balanse';
    runwayBox.style.borderColor='var(--red)';
  } else if(monthlyNet>=0){
    runwayEl.textContent='âˆž';runwaySub.textContent='Cash flow-positiv';
    runwayBox.style.borderColor='var(--green)';
  } else {
    const mths=Math.floor(final/(-monthlyNet));
    runwayEl.textContent=mths+' mnd';
    runwaySub.innerHTML=mths<6?'<span class="status-dot red"></span>Kritisk':mths<12?'<span class="status-dot yellow"></span>BÃ¸r planlegge':'<span class="status-dot green"></span>Solid posisjon';
    runwayBox.style.borderColor=mths<6?'var(--red)':mths<12?'var(--yellow)':'var(--green)';
  }

  // AGA detail
  if(aga && agaTotal>0){
    document.getElementById('agaDetail').innerHTML=`AGA ${year}: <strong>${fmt(Math.round(agaTotal))}</strong> i terminbetalinger${agaResult.term6Carry>0?` Â· Term 6 â†’ jan ${year+1}: <strong>${fmt(Math.round(agaResult.term6Carry))}</strong>`:''}`;
  } else if(aga) {
    document.getElementById('agaDetail').innerHTML='Terminbetaling: annenhver mÃ¥ned. Ingen ansatte med AGA-grunnlag.';
  } else {
    document.getElementById('agaDetail').innerHTML='AGA deaktivert';
  }

  // Feriepenger detail
  if(document.getElementById('ferieToggle').checked){
    const fr = ferieResult;
    let html = '';
    if (fr.payout > 0) {
      const hasOver60 = fr.details.some(d => d.over60);
      html += `<strong>Juni ${year}:</strong> `;
      html += `Utbetaling: ${fmt(Math.round(fr.payout))}`;
      html += ` Â· Spart lÃ¸nn: âˆ’${fmt(Math.round(fr.saved))}`;
      const netto = fr.payout - fr.saved;
      html += ` Â· <strong>Netto: ${netto>=0?'+':'âˆ’'}${fmt(Math.round(Math.abs(netto)))}</strong>`;
      if (hasOver60) html += ` <span style="color:var(--accent)">(inkl. 14,3% for 60+)</span>`;
    } else {
      html += `Ingen feriepenger i ${year} (ingen ansatte med opptjening i ${year-1})`;
    }
    if (fr.accrual > 0) {
      html += `<br>Avsetning ${year}: ${fmt(Math.round(fr.accrual))} (${fmt(Math.round(fr.accrualMonthly))}/mnd) â†’ utbetales juni ${year+1}`;
    }
    document.getElementById('ferieDetail').innerHTML = html;
  } else { document.getElementById('ferieDetail').innerHTML='Feriepenger deaktivert'; }

  // Bar chart
  const stressOn = document.getElementById('stressToggle').checked;
  const minBal = stressOn ? (parseInt(document.getElementById('stressMinBalance').value) || 0) : 0;

  const bc=document.getElementById('barChart'),bl=document.getElementById('barLabels');bc.innerHTML='';bl.innerHTML='';
  const mx=Math.max(...closing.map(v=>Math.abs(v)),1);
  closing.forEach((v,i)=>{
    const bar=document.createElement('div');bar.className='balance-bar';
    bar.style.height=Math.max(20,(Math.abs(v)/mx)*100)+'%';
    if(v<0)bar.classList.add('negative');else if(minBal>0&&v<minBal)bar.classList.add('warning');else if(v<avgOut*2)bar.classList.add('warning');else bar.classList.add('positive');
    bar.innerHTML=`<span class="bar-label">${fmtK(v)}</span>`;bar.title=`${MONTHS[i]} ${year}: ${fmt(Math.round(v))} NOK`;
    bc.appendChild(bar);const l=document.createElement('div');l.textContent=MONTHS[i];bl.appendChild(l);
  });

  // â•â•â• STRESS TEST â•â•â•
  const sbc=document.getElementById('stressBarChart'),sbl=document.getElementById('stressBarLabels');
  sbc.innerHTML='';sbl.innerHTML='';

  if(stressOn){
    const sDelay=parseInt(document.getElementById('stressDelayMonths').value)||0;
    const sIncRed=(parseInt(document.getElementById('stressIncomeReduction').value)||0)/100;
    const sCostUp=(parseInt(document.getElementById('stressCostIncrease').value)||0)/100;

    // Apply stress to income arrays
    let sFixInc=mFixedIncomeShifted.map(v=>v*(1-sIncRed));
    let sVarInc=mVarIncomeShifted.map(v=>v*(1-sIncRed));
    if(sDelay>0){sFixInc=shiftMonths(sFixInc,sDelay);sVarInc=shiftMonths(sVarInc,sDelay);}
    const sUtg=mvaEnabled?sFixInc.map((v,m)=>{
      // Recalc MVA on stressed income
      let u=0;
      fixedIncome.forEach(c=>{if(!c.mva)return;const a=(parseFloat(c.amount)||0)*0.25*(1-sIncRed);if(isActive(c.startDate,c.endDate,year,m))u+=a;});
      varIncomeEntries.forEach(e=>{if(!e.mva||!e.date)return;const p=e.date.split('-');if(parseInt(p[0])===year&&parseInt(p[1])-1===m)u+=(parseFloat(e.amount)||0)*0.25*(1-sIncRed);});
      return u;
    }):new Array(12).fill(0);

    // Apply stress to cost arrays
    const sFixCost=mFixCostShifted.map(v=>v*(1+sCostUp));
    const sVarCost=mVarShifted.map(v=>v*(1+sCostUp));
    const sInn=mvaEnabled?sFixCost.map((v,m)=>{
      let inn=0;
      fixedCosts.forEach(c=>{if(!c.mva)return;const a=(parseFloat(c.amount)||0)*0.25*(1+sCostUp);if(isActive(c.startDate,c.endDate,year,m))inn+=a;});
      varEntries.forEach(e=>{if(!e.mva||!e.date)return;const p=e.date.split('-');if(parseInt(p[0])===year&&parseInt(p[1])-1===m)inn+=(parseFloat(e.amount)||0)*0.25*(1+sCostUp);});
      return inn;
    }):new Array(12).fill(0);

    // Stressed MVA settlement (simplified: use base settlement adjusted)
    const sMvaSettle=mvaSettle.map(v=>v); // Keep base MVA settlement for simplicity

    // Compute stressed cash flows
    const sInArr=[],sOutArr=[],sBals=[];
    let sRunning=ib;
    for(let m=0;m<12;m++){
      const sCashIn=sFixInc[m]+sVarInc[m]+sUtg[m]+loanAgg.disbursement[m];
      const sCashOut=persPerMonth[m]+sFixCost[m]+sVarCost[m]+loanAgg.total[m]+leaseAgg.total[m]+sInn[m]+feriePenger[m]+agaPayments[m]+forskuddsskatt[m];
      sInArr.push(sCashIn);
      sOutArr.push(sCashOut);
      const sOpen=sRunning;
      sRunning=sOpen+sCashIn+mCapital[m]-sCashOut-sMvaSettle[m];
      sBals.push({open:sOpen,close:sRunning});
    }
    const sClosing=sBals.map(b=>b.close);
    const sNetArr=sInArr.map((v,m)=>v+mCapital[m]-sOutArr[m]-sMvaSettle[m]);

    // Stress bar chart
    const smx=Math.max(...sClosing.map(v=>Math.abs(v)),mx,1);
    sClosing.forEach((v,i)=>{
      const bar=document.createElement('div');bar.className='balance-bar';
      bar.style.height=Math.max(20,(Math.abs(v)/smx)*100)+'%';
      if(v<0)bar.classList.add('negative');else if(minBal>0&&v<minBal)bar.classList.add('warning');else bar.classList.add('positive');
      bar.innerHTML=`<span class="bar-label">${fmtK(v)}</span>`;bar.title=`STRESS ${MONTHS[i]} ${year}: ${fmt(Math.round(v))} NOK`;
      sbc.appendChild(bar);const l=document.createElement('div');l.textContent=MONTHS[i];sbl.appendChild(l);
    });

    // Stress comparison table
    const sHdr=document.getElementById('stressHeaderRow');
    sHdr.innerHTML='<th style="text-align:left">Sammenligning</th>';
    MONTHS.forEach(mo=>{sHdr.innerHTML+=`<th>${mo} ${year}</th>`;});
    sHdr.innerHTML+='<th style="background:var(--accent)">Totalt</th>';

    const stb=document.getElementById('stressBody');stb.innerHTML='';
    function addStressRow(label,vals,cls){
      const tr=document.createElement('tr');if(cls)tr.className=cls;
      const tot=vals.reduce((a,b)=>a+b,0);let c=`<td>${label}</td>`;
      vals.forEach((v,m)=>{
        const breach=(cls&&cls.includes('balance')&&minBal>0&&v<minBal);
        c+=`<td${v<0?' class="negative-val"':''}${breach?' class="breach-cell"':''}>${fmt(Math.round(v))}</td>`;
      });
      const tBreach=(cls&&cls.includes('balance')&&minBal>0);
      c+=`<td${tot<0?' class="negative-val"':''}><strong>${fmt(Math.round(cls&&cls.includes('balance')?vals[11]:tot))}</strong></td>`;
      tr.innerHTML=c;stb.appendChild(tr);
    }

    addStressRow('Innbetalinger (base)',inArr);
    addStressRow('Innbetalinger (stress)',sInArr,'row-stress');
    let sSp=document.createElement('tr');sSp.innerHTML='<td colspan="14" style="padding:2px;border:none;background:white"></td>';stb.appendChild(sSp);
    addStressRow('Utbetalinger (base)',outArr);
    addStressRow('Utbetalinger (stress)',sOutArr,'row-stress');
    sSp=document.createElement('tr');sSp.innerHTML='<td colspan="14" style="padding:2px;border:none;background:white"></td>';stb.appendChild(sSp);
    addStressRow('Netto kontantstrÃ¸m (base)',netArr);
    addStressRow('Netto kontantstrÃ¸m (stress)',sNetArr,'row-stress');
    sSp=document.createElement('tr');sSp.innerHTML='<td colspan="14" style="padding:2px;border:none;background:white"></td>';stb.appendChild(sSp);

    // Closing balances with breach highlighting
    const baseBalTr=document.createElement('tr');baseBalTr.className='row-balance';
    let bC='<td>UB (base)</td>';
    closing.forEach((v,m)=>{const breach=minBal>0&&v<minBal;bC+=`<td${breach?' class="breach-cell"':''}${v<0&&!breach?' class="negative-val"':''}><strong>${fmt(Math.round(v))}</strong></td>`;});
    bC+=`<td><strong>${fmt(Math.round(closing[11]))}</strong></td>`;
    baseBalTr.innerHTML=bC;stb.appendChild(baseBalTr);

    const stressBalTr=document.createElement('tr');stressBalTr.className='row-stress-balance';
    let sC='<td>UB (stress)</td>';
    sClosing.forEach((v,m)=>{const breach=minBal>0&&v<minBal;sC+=`<td${breach?' class="breach-cell"':''}><strong>${fmt(Math.round(v))}</strong></td>`;});
    sC+=`<td><strong>${fmt(Math.round(sClosing[11]))}</strong></td>`;
    stressBalTr.innerHTML=sC;stb.appendChild(stressBalTr);

    // Difference row
    const diffVals=closing.map((v,m)=>sClosing[m]-v);
    const diffTr=document.createElement('tr');diffTr.className='row-stress-diff';
    let dC='<td>Î” Differanse</td>';
    diffVals.forEach(v=>{dC+=`<td${v<0?' class="negative-val"':''}>${v>0?'+':''}${fmt(Math.round(v))}</td>`;});
    dC+=`<td${diffVals[11]<0?' class="negative-val"':''}><strong>${diffVals[11]>0?'+':''}${fmt(Math.round(diffVals[11]))}</strong></td>`;
    diffTr.innerHTML=dC;stb.appendChild(diffTr);

    // Min balance line info
    if(minBal>0){
      sSp=document.createElement('tr');sSp.innerHTML='<td colspan="14" style="padding:2px;border:none;background:white"></td>';stb.appendChild(sSp);
      const minBalTr=document.createElement('tr');
      let mC=`<td style="font-size:11px;color:var(--red)">âš  Minimumsbalanse: ${fmt(minBal)}</td>`;
      closing.forEach((v,m)=>{const breach=v<minBal||sClosing[m]<minBal;mC+=`<td style="font-size:10px;color:${breach?'var(--red)':'var(--green)'}">${breach?'BRUDD':'OK'}</td>`;});
      mC+='<td></td>';minBalTr.innerHTML=mC;stb.appendChild(minBalTr);
    }

    // Stress detail summary
    const sBreachMonths=sClosing.filter(v=>minBal>0&&v<minBal).length;
    const bBreachMonths=closing.filter(v=>minBal>0&&v<minBal).length;
    const sMinVal=Math.min(...sClosing);
    const sMinMonth=MONTHS[sClosing.indexOf(sMinVal)];
    let detailHtml=`Stresseffekt pÃ¥ UB des: <strong class="${diffVals[11]<0?'negative-val':''}">${diffVals[11]>0?'+':''}${fmt(Math.round(diffVals[11]))}</strong>`;
    detailHtml+=` Â· Laveste stress-UB: <strong class="${sMinVal<0?'negative-val':''}">${fmt(Math.round(sMinVal))}</strong> (${sMinMonth})`;
    if(minBal>0){
      detailHtml+=` Â· Brudd base: <strong>${bBreachMonths}</strong> mnd Â· Brudd stress: <strong class="${sBreachMonths>0?'negative-val':''}">${sBreachMonths}</strong> mnd`;
    }
    document.getElementById('stressDetail').innerHTML=detailHtml;
  }
}

/* â•â•â• INIT â•â•â• */
function renderAll(){renderFixed();renderFixedIncome();renderEntries('varIncome');renderEntries('var');renderEntries('capital');renderEmployees();renderLoans();renderLeases();}
renderAll();updateSliders();recalculate();
// Expose functions globally for artifact environments
window.loadVDRtoCalc=loadVDRtoCalc;
window.toggleVDR=toggleVDR;
window.renderVDR=renderVDR;
window.showVDRMsg=showVDRMsg;
window.toggleStress=toggleStress;
window.recalculate=recalculate;
window.renderAll=renderAll;
window.updateSliders=updateSliders;
window.renderEmployees=renderEmployees;
window.renderFixed=renderFixed;
window.renderFixedIncome=renderFixedIncome;
window.renderEntries=renderEntries;
window.renderLoans=renderLoans;
window.renderLeases=renderLeases;
window.addEmployee=addEmployee;
window.addFixed=addFixed;
window.addFixedIncome=addFixedIncome;
window.addEntry=addEntry;
window.addLoan=addLoan;
window.addLease=addLease;
window.changeYear=changeYear;
window.onYearChange=onYearChange;
window.onIBChange=onIBChange;
window.saveData=saveData;
window.loadData=loadData;
window.toggleForskuddsskatt=toggleForskuddsskatt;
window.updateFixedTotal=updateFixedTotal;
window.updateFixedIncomeTotal=updateFixedIncomeTotal;
window.updateEmployeeFooter=updateEmployeeFooter;
window.updateEntryTotal=updateEntryTotal;
// Diagnostic
var diag=document.getElementById('vdrDiag');
if(diag)diag.textContent=typeof loadVDRtoCalc==='function'?'âœ“ klar':'âœ— ikke lastet';
// Programmatic listener for VDR button
var vdrBtn=document.getElementById('vdrLoadBtn');
if(vdrBtn){vdrBtn.addEventListener('click',function(){try{loadVDRtoCalc();}catch(e){var d=document.getElementById('vdrDiag');if(d)d.textContent='ERR: '+e.message;}});}
// Programmatic listeners for stress inputs
['stressDelayMonths','stressIncomeReduction','stressCostIncrease','stressMinBalance'].forEach(function(id){
  var el=document.getElementById(id);
  if(el){el.addEventListener('input',function(){recalculate();});el.addEventListener('change',function(){recalculate();});}
});
// Programmatic listener for stress toggle
var stToggle=document.getElementById('stressToggle');
if(stToggle){stToggle.addEventListener('change',function(){toggleStress();recalculate();});}
// Programmatic listener for VDR toggle + year
var vdrTog=document.getElementById('vdrToggle');
if(vdrTog){vdrTog.addEventListener('change',function(){toggleVDR();});}
var vdrYr=document.getElementById('vdrYear');
if(vdrYr){vdrYr.addEventListener('change',function(){renderVDR();});}
// Key calculator inputs
['ibInput','gInput','debtorDays','creditorDays','forskuddsskattBasis'].forEach(function(id){
  var el=document.getElementById(id);
  if(el){el.addEventListener('input',function(){recalculate();});}
});
['otpOver7G','agaToggle','ferieToggle','mvaToggle','forskuddsskattToggle'].forEach(function(id){
  var el=document.getElementById(id);
  if(el){el.addEventListener('change',function(){recalculate();});}
});
var otpSl=document.getElementById('otpSlider');
if(otpSl){otpSl.addEventListener('input',function(){updateSliders();renderEmployees();recalculate();});}
var vyEl=document.getElementById('viewYear');
if(vyEl){vyEl.addEventListener('change',function(){onYearChange();});}
</script>
</body>
</html>
